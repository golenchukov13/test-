<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KIDCIRCLE - Полезная информация для родителей</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&family=Nunito:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #6c5ce7;
            --primary-dark: #4b47c2;
            --secondary: #ff6b6b;
            --accent: #00d1b2;
            --light: #f7fafc;
            --dark: #1f2430;
            --gray: #8a93a6;
            --light-gray: #e2e8f0;
            --transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            --neon: #00fff0;
            --neon-2: #a56eff;
            --bg-gradient: linear-gradient(135deg, #f5f7ff 0%, #e5e9ff 100%);
            --surface: rgba(255, 255, 255, 0.95);
            --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --sidebar-width: 280px;
            --header-height: 80px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        html, body {
            height: 100%;
            background: var(--bg-gradient);
            color: var(--dark);
            line-height: 1.6;
            font-family: 'Nunito', sans-serif;
            overflow-x: hidden;
        }
        
        h1, h2, h3, h4, h5, h6 {
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
        }
        
        /* Основная структура для десктопа */
        .app-container {
            display: flex;
            min-height: 100vh;
        }
        
        /* Левое меню */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--surface);
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            z-index: 100;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }
        
        .logo-section {
            padding: 25px 20px;
            border-bottom: 1px solid var(--light-gray);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 800;
            font-size: 1.4rem;
            color: var(--primary);
            text-decoration: none;
        }
        
        .logo-icon {
            color: var(--secondary);
            font-size: 1.6rem;
        }
        
        .nav-section {
            flex: 1;
            padding: 20px 0;
        }
        
        .nav-item {
            display: flex;
            align-items: center;
            padding: 15px 25px;
            text-decoration: none;
            color: var(--dark);
            transition: var(--transition);
            cursor: pointer;
            border-left: 4px solid transparent;
        }
        
        .nav-item:hover {
            background: rgba(108, 92, 231, 0.05);
            color: var(--primary);
        }
        
        .nav-item.active {
            background: rgba(108, 92, 231, 0.1);
            color: var(--primary);
            border-left-color: var(--primary);
        }
        
        .nav-icon {
            width: 24px;
            font-size: 1.2rem;
            margin-right: 15px;
        }
        
        .nav-text {
            font-size: 1rem;
            font-weight: 600;
        }
        
        .user-section {
            padding: 20px;
            border-top: 1px solid var(--light-gray);
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: var(--transition);
        }

        .user-section:hover {
            background: rgba(108, 92, 231, 0.05);
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }
        
        .user-info {
            flex: 1;
        }
        
        .user-name {
            font-weight: 600;
            font-size: 0.95rem;
        }
        
        .user-city {
            font-size: 0.8rem;
            color: var(--gray);
        }
        
        /* Основной контент */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            padding: 30px;
            max-width: calc(100% - var(--sidebar-width));
        }
        
        /* Секция теста с анимацией волны */
        .test-section {
            background: transparent;
            border-radius: 0;
            padding: 0;
            box-shadow: none;
            margin-bottom: 28px;
            position: relative;
            overflow: visible;
        }
        
        .test-title {
            font-size: 2rem;
            margin-bottom: 10px;
            color: var(--primary);
            font-weight: 800;
        }
        
        .test-desc {
            margin-bottom: 25px;
            color: var(--gray);
            font-size: 1.1rem;
            max-width: 600px;
        }
        
        .wave-container {
            position: relative;
            height: 340px;
            margin-bottom: 25px;
            overflow: hidden;
            border-radius: 16px;
            background: radial-gradient(circle at 50% 50%, #6c5ce7 0%, #4b47c2 55%, #2b2785 100%);
            box-shadow: 0 18px 40px rgba(108, 92, 231, 0.35);
        }
        .wave-container .overlay-top {
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at 20% 20%, rgba(255,255,255,0.2), transparent 40%),
                        radial-gradient(circle at 80% 25%, rgba(255,255,255,0.15), transparent 45%),
                        linear-gradient(to bottom, rgba(0,0,0,0.15), rgba(0,0,0,0) 35%);
            pointer-events: none;
            z-index: 1;
        }
        .wave-container::before {
            content: '';
            position: absolute;
            inset: -40%;
            background: radial-gradient(circle at 30% 20%, rgba(255,255,255,0.18), transparent 40%),
                        radial-gradient(circle at 70% 30%, rgba(255,255,255,0.12), transparent 45%),
                        radial-gradient(circle at 50% 80%, rgba(0,0,0,0.12), transparent 50%);
            filter: blur(20px);
            animation: glowShift 8s ease-in-out infinite alternate;
        }
        @keyframes glowShift {
            0% { transform: translateY(0) scale(1); opacity: 0.7; }
            100% { transform: translateY(-10px) scale(1.05); opacity: 1; }
        }
        
        .wave {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.3);
            width: 260px;
            height: 260px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(255,255,255,0.35) 0 38%, rgba(255,255,255,0.18) 39% 50%, transparent 51% 100%);
            box-shadow: 0 0 40px rgba(255,255,255,0.08);
            animation: ripple 6.5s ease-out infinite;
        }
        .wave:nth-of-type(2) {
            background: radial-gradient(circle, rgba(0,255,240,0.35) 0 38%, rgba(0,255,240,0.18) 39% 50%, transparent 51% 100%);
            animation-delay: 1.3s;
            filter: blur(0.5px);
        }
        .wave:nth-of-type(3) {
            background: radial-gradient(circle, rgba(165,110,255,0.35) 0 38%, rgba(165,110,255,0.18) 39% 50%, transparent 51% 100%);
            animation-delay: 2.6s;
            filter: blur(1px);
        }

        @keyframes ripple {
            0% { transform: translate(-50%, -50%) scale(0.3); opacity: 0.85; }
            60% { opacity: 0.3; }
            100% { transform: translate(-50%, -50%) scale(5); opacity: 0; }
        }
        
        @keyframes wave {
            0% {
                background-position-x: 0;
            }
            100% {
                background-position-x: 1200px;
            }
        }
        
        @keyframes swell {
            0%, 100% {
                transform: translateY(-10px);
            }
            50% {
                transform: translateY(10px);
            }
        }
        
        .wave-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: white;
            z-index: 2;
            background: rgba(0,0,0,0.22);
            backdrop-filter: blur(6px);
            padding: 18px 22px;
            border-radius: 16px;
            box-shadow: 0 12px 30px rgba(0,0,0,0.25);
        }
        
        .wave-title {
            font-size: 2.2rem;
            margin-bottom: 12px;
            font-weight: 800;
            letter-spacing: 0.3px;
            text-shadow: 0 6px 20px rgba(0,0,0,0.25);
        }
        
        .wave-subtitle {
            font-size: 1.05rem;
            opacity: 0.96;
            margin-bottom: 14px;
        }
        
        .start-test-btn {
            display: inline-block;
            padding: 14px 32px;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.34);
            border-radius: 34px;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            transition: var(--transition);
            text-decoration: none;
            box-shadow: 0 10px 30px rgba(0,0,0,0.18), 0 0 0 0 rgba(255,255,255,0.5);
            animation: glow-pulse 2.6s infinite ease-in-out;
        }
        
        .start-test-btn:hover {
            background: rgba(255, 255, 255, 0.34);
            transform: translateY(-3px) scale(1.01);
        }
        @keyframes glow-pulse {
            0% { box-shadow: 0 10px 30px rgba(0,0,0,0.18), 0 0 0 0 rgba(255,255,255,0.45); }
            70% { box-shadow: 0 10px 30px rgba(0,0,0,0.18), 0 0 0 16px rgba(255,255,255,0); }
            100% { box-shadow: 0 10px 30px rgba(0,0,0,0.18), 0 0 0 0 rgba(255,255,255,0); }
        }

        /* Floating bubbles */
        .bubble { position: absolute; bottom: -40px; border-radius: 50%; background: rgba(255,255,255,0.15); filter: blur(0.5px); animation: floatUp linear infinite; }
        .bubble.small { width: 8px; height: 8px; animation-duration: 8s; }
        .bubble.mid { width: 14px; height: 14px; animation-duration: 10s; }
        .bubble.big { width: 22px; height: 22px; animation-duration: 12s; }
        @keyframes floatUp { from { transform: translateY(0); opacity: 0.7; } to { transform: translateY(-380px); opacity: 0; } }
        
        /* Контент главной страницы */
        .content-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
        }
        
        .main-column {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }
        
        .sidebar-column {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }
        
        /* Карточки контента */
        .content-card {
            background: white;
            border-radius: 16px;
            padding: 25px;
            box-shadow: var(--card-shadow);
        }
        
        .section-title {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: var(--dark);
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .view-all {
            font-size: 0.9rem;
            color: var(--primary);
            text-decoration: none;
            font-weight: 600;
        }
        
        .promo-blocks {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .promo-block {
            height: 140px;
            border-radius: 16px;
            padding: 20px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--neon-2) 100%);
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            position: relative;
            overflow: hidden;
            transition: var(--transition);
            cursor: pointer;
        }
        
        .promo-block:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        
        .promo-block:nth-child(2) {
            background: linear-gradient(135deg, var(--secondary) 0%, #ff9e9e 100%);
        }
        
        .promo-block:nth-child(3) {
            background: linear-gradient(135deg, var(--accent) 0%, #00ffd1 100%);
        }
        
        .promo-block:nth-child(4) {
            background: linear-gradient(135deg, #ffc107 0%, #ffd54f 100%);
        }
        
        .promo-title {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 5px;
            z-index: 2;
        }
        
        .promo-subtitle {
            font-size: 0.9rem;
            opacity: 0.9;
            z-index: 2;
        }
        
        .promo-icon {
            position: absolute;
            right: 20px;
            top: 20px;
            font-size: 2.5rem;
            opacity: 0.2;
        }
        
        /* Стили для статей */
        .articles-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }
        
        .article-card {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: var(--card-shadow);
            transition: var(--transition);
            cursor: pointer;
        }
        
        .article-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        
        .article-image {
            height: 160px;
            background: linear-gradient(120deg, #5e72e4 0%, #9c7be4 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.4rem;
            position: relative;
        }
        
        .article-badge {
            position: absolute;
            top: 15px;
            left: 15px;
            background: var(--secondary);
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 700;
        }
        
        .article-content {
            padding: 20px;
        }
        
        .article-title {
            font-size: 1.1rem;
            margin-bottom: 10px;
            font-weight: 700;
            line-height: 1.4;
        }
        
        .article-excerpt {
            margin-bottom: 15px;
            color: #555;
            font-size: 0.95rem;
            line-height: 1.5;
        }
        
        .article-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
            color: var(--gray);
        }
        
        /* Стили для экрана теста */
        .test-screen {
            display: none !important;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            -webkit-backdrop-filter: blur(6px);
            backdrop-filter: blur(6px);
            z-index: 1500;
            padding: 40px 20px;
            overflow: auto;
        }
        
        .test-screen.active {
            display: block !important;
        }

        .test-card {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.2);
        }
        
        .test-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }
        
        .test-progress {
            height: 10px;
            background: var(--light-gray);
            border-radius: 5px;
            margin-bottom: 25px;
            overflow: hidden;
            position: relative;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--neon-2));
            border-radius: 5px;
            transition: width 0.5s ease;
            width: 0%;
            position: relative;
            overflow: hidden;
        }
        
        .progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background-image: linear-gradient(
                -45deg, 
                rgba(255, 255, 255, 0.2) 25%, 
                transparent 25%, 
                transparent 50%, 
                rgba(255, 255, 255, 0.2) 50%, 
                rgba(255, 255, 255, 0.2) 75%, 
                transparent 75%, 
                transparent
            );
            z-index: 1;
            background-size: 20px 20px;
            animation: move 1s linear infinite;
            overflow: hidden;
        }
        
        @keyframes move {
            0% {
                background-position: 0 0;
            }
            100% {
                background-position: 20px 0;
            }
        }
        
        .question-text {
            font-size: 1.3rem;
            margin-bottom: 25px;
            text-align: center;
            font-weight: 600;
            line-height: 1.4;
        }
        
        .options-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .option-item {
            padding: 20px 20px 20px 70px;
            background: var(--light);
            border-radius: 15px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
            cursor: pointer;
            font-size: 1rem;
            position: relative;
            overflow: hidden;
        }
        
        .option-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        
        .option-item.selected {
            background: rgba(108, 92, 231, 0.1);
            border-color: var(--primary);
            color: var(--primary-dark);
            font-weight: 600;
        }
        
        .option-icon {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            width: 35px;
            height: 35px;
            background: var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }
        
        .test-nav {
            display: flex;
            justify-content: space-between;
        }
        
        .nav-btn {
            padding: 14px 25px;
            border-radius: 25px;
            font-weight: 700;
            border: none;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        
        .nav-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
        }
        
        .nav-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        .nav-btn.prev {
            background: var(--light);
            color: var(--dark);
        }
        
        .nav-btn.next {
            background: linear-gradient(135deg, var(--primary) 0%, var(--neon-2) 100%);
            color: white;
        }
        
        /* Стили для результатов теста */
        .results-screen {
            display: none !important;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            -webkit-backdrop-filter: blur(6px);
            backdrop-filter: blur(6px);
            z-index: 1500;
            padding: 40px 20px;
            overflow: auto;
        }
        
        .results-screen.active {
            display: block !important;
        }

        .results-card {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.2);
        }
        
        .result-category {
            display: flex;
            align-items: center;
            padding: 20px;
            background: var(--light);
            border-radius: 15px;
            margin-bottom: 15px;
            transition: var(--transition);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        }
        
        .result-category:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
        }
        
        .category-match {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--neon-2) 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 20px;
            font-size: 1.2rem;
            box-shadow: 0 4px 10px rgba(108, 92, 231, 0.3);
        }
        
        .category-info {
            flex: 1;
        }
        
        .category-name {
            font-weight: 700;
            margin-bottom: 5px;
            font-size: 1.1rem;
        }
        
        .category-desc {
            font-size: 0.9rem;
            color: var(--gray);
        }
        
        /* Анимация загрузки ИИ */
        .ai-thinking {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s ease;
        }
        #ai-canvas {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            display: block;
            z-index: 0;
        }
        
        .ai-thinking.active {
            opacity: 1;
            visibility: visible;
        }
        
        .ai-brain {
            width: 150px;
            height: 150px;
            position: relative;
            margin-bottom: 40px;
        }
        
        .ai-brain i {
            font-size: 100px;
            color: #7cf3ff;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 2;
            text-shadow: 0 0 24px rgba(124, 243, 255, 0.6), 0 0 48px rgba(165, 110, 255, 0.35);
        }
        
        .pulse {
            position: absolute;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(124,243,255,0.8), rgba(124,243,255,0.0) 70%);
            border-radius: 50%;
            opacity: 0;
            transform: scale(0);
            animation: pulse 3s infinite linear;
        }
        
        .pulse:nth-child(2) {
            animation-delay: 0.7s;
        }
        
        .pulse:nth-child(3) {
            animation-delay: 1.4s;
        }
        
        @keyframes pulse {
            0% {
                transform: scale(0);
                opacity: 0.8;
            }
            100% {
                transform: scale(1.5);
                opacity: 0;
            }
        }
        
        .ai-text {
            font-size: 1.4rem;
            font-weight: 700;
            color: #d9f7ff;
            text-align: center;
            margin-bottom: 30px;
            text-shadow: 0 0 14px rgba(124, 243, 255, 0.45), 0 0 30px rgba(165,110,255,0.25);
            animation: aiGlow 2.8s ease-in-out infinite;
        }
        @keyframes aiGlow {
            0%, 100% { opacity: 0.9; text-shadow: 0 0 12px rgba(124,243,255,0.35), 0 0 24px rgba(165,110,255,0.18); }
            50% { opacity: 1; text-shadow: 0 0 20px rgba(124,243,255,0.65), 0 0 40px rgba(165,110,255,0.35); }
        }
        
        .ai-dots {
            display: flex;
            gap: 8px;
        }
        
        .ai-dot {
            width: 15px;
            height: 15px;
            background: radial-gradient(circle at 35% 35%, #7cf3ff, #a56eff);
            border-radius: 50%;
            animation: dot-bounce 2.2s infinite ease-in-out;
            box-shadow: 0 0 12px rgba(124, 243, 255, 0.35), 0 0 24px rgba(165,110,255,0.25);
        }
        
        .ai-dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .ai-dot:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes dot-bounce {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-15px);
            }
        }

        /* Стили для других экранов */
        .screen {
            display: none;
        }
        
        .screen.active {
            display: block;
        }
        
        /* Стили для экрана онбординга */
        .onboarding-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: var(--bg-gradient);
            z-index: 3000;
            overflow: hidden;
        }
        
        .onboarding-slides {
            display: flex;
            width: calc(8 * 100vw);
            height: 100vh;
            transition: transform 0.4s ease;
        }
        
        .onboarding-slide {
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            text-align: center;
        }
        
        .onboarding-image {
            width: 250px;
            height: 250px;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(45deg, var(--primary), var(--neon-2));
            border-radius: 20px;
            color: white;
            font-size: 100px;
        }
        
        .onboarding-title {
            font-size: 1.8rem;
            margin-bottom: 15px;
            color: var(--dark);
        }
        
        .onboarding-text {
            font-size: 1rem;
            color: var(--gray);
            margin-bottom: 30px;
            max-width: 300px;
        }
        
        .onboarding-indicators {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
        }
        
        .onboarding-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--light-gray);
            transition: var(--transition);
        }
        
        .onboarding-indicator.active {
            background: var(--primary);
            width: 24px;
            border-radius: 4px;
        }
        
        .onboarding-btn {
            padding: 14px 30px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 25px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .onboarding-btn.skip {
            background: transparent;
            color: var(--gray);
            margin-top: 10px;
        }
        
        .onboarding-btn:active {
            transform: scale(0.98);
        }
        
        /* Форма ввода данных */
        .form-container {
            width: 100%;
            max-width: 400px;
            padding: 20px;
        }
        
        .form-title {
            text-align: center;
            font-size: 1.8rem;
            margin-bottom: 10px;
            color: var(--dark);
        }
        
        .form-subtitle {
            text-align: center;
            color: var(--gray);
            margin-bottom: 30px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
        }
        
        .form-input {
            width: 100%;
            padding: 14px;
            border: 1px solid var(--light-gray);
            border-radius: 12px;
            font-size: 1rem;
        }
        
        .form-btn {
            width: 100%;
            padding: 14px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: var(--transition);
            margin-top: 10px;
        }
        
        .form-btn:active {
            transform: scale(0.98);
        }
        
        .code-inputs {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
        }
        
        .code-input {
            width: 50px;
            height: 60px;
            border: 1px solid var(--light-gray);
            border-radius: 12px;
            text-align: center;
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .timer-text {
            text-align: center;
            color: var(--gray);
            margin-bottom: 20px;
        }
        
        .resend-link {
            color: var(--primary);
            text-decoration: none;
            font-weight: 600;
            cursor: pointer;
        }
        
        /* Стили для экрана поиска */
        .search-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            gap: 10px;
        }
        
        .search-input-container {
            flex: 1;
            position: relative;
        }
        
        .search-input {
            width: 100%;
            padding: 14px 45px 14px 15px;
            border: 1px solid var(--light-gray);
            border-radius: 12px;
            font-size: 1rem;
            background: white;
        }
        
        .search-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray);
        }
        
        .filter-icon {
            width: 45px;
            height: 45px;
            border-radius: 12px;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            cursor: pointer;
        }
        .filter-icon:active { transform: scale(0.98); }
        
        .search-filters {
            display: flex;
            overflow-x: auto;
            gap: 10px;
            margin-bottom: 20px;
            padding: 5px 0;
            -webkit-overflow-scrolling: touch;
        }
        
        .search-filters::-webkit-scrollbar {
            display: none;
        }
        
        .filter-chip {
            padding: 10px 18px;
            background: white;
            border: 1px solid var(--light-gray);
            border-radius: 20px;
            font-size: 0.9rem;
            white-space: nowrap;
            transition: var(--transition);
            cursor: pointer;
        }
        
        .filter-chip.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .search-results {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 16px;
        }
        @media (max-width: 900px) { .search-results { grid-template-columns: 1fr; } }
        
        .result-card {
            position: relative;
            background: linear-gradient(180deg, #ffffff 0%, #fafbff 100%);
            border-radius: 18px;
            overflow: hidden;
            box-shadow: 0 10px 24px rgba(0,0,0,0.08);
            border: 1px solid var(--light-gray);
            transition: transform .25s ease, box-shadow .25s ease;
            transform-style: preserve-3d;
        }
        .result-card::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 18px;
            padding: 1px;
            background: linear-gradient(135deg, rgba(108,92,231,0.35), rgba(165,110,255,0.35));
            -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            pointer-events: none;
        }
        .result-card::after {
            content: '';
            position: absolute;
            top: -60%; left: -20%; right: -20%; height: 120%;
            background: linear-gradient(90deg, rgba(255,255,255,0.0), rgba(255,255,255,0.25), rgba(255,255,255,0.0));
            transform: rotate(8deg);
            opacity: 0;
            transition: opacity .25s ease, transform .25s ease;
            pointer-events: none;
        }
        .result-card:hover { transform: translateY(-4px) rotateX(2deg); box-shadow: 0 16px 34px rgba(0,0,0,0.14); }
        .result-card:hover::after { opacity: 1; transform: rotate(8deg) translateY(8px); }
        
        .result-image {
            height: 120px;
            background: linear-gradient(120deg, #5e72e4 0%, #9c7be4 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.4rem;
            position: relative;
        }
        .result-icon { position:absolute; left:14px; top:14px; font-size:1.3rem; opacity:.85; }
        .result-icon i { filter: drop-shadow(0 4px 10px rgba(0,0,0,0.25)); }
        
        .result-badge {
            position: absolute;
            top: 14px;
            right: 14px;
            color: #fff;
            padding: 6px 12px;
            border-radius: 999px;
            font-size: 0.78rem;
            font-weight: 800;
            backdrop-filter: blur(6px);
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .result-badge.badge-premium { background: linear-gradient(135deg, #f6d365, #fda085); box-shadow: 0 6px 14px rgba(253,160,133,0.35); }
        .result-badge.badge-new { background: linear-gradient(135deg, #00d2ff, #3a7bd5); box-shadow: 0 6px 14px rgba(58,123,213,0.35); }
        
        /* Favorite button under badge */
        .fav-btn { position: absolute; top: 52px; right: 16px; width: 34px; height: 34px; border-radius: 50%; background: #fff; border: 1px solid var(--light-gray); display: inline-flex; align-items: center; justify-content: center; color: var(--secondary); box-shadow: 0 6px 14px rgba(0,0,0,0.08); cursor: pointer; transition: transform .15s ease, box-shadow .15s ease; z-index: 2; }
        .fav-btn:hover { transform: translateY(-1px); box-shadow: 0 8px 18px rgba(0,0,0,0.12); }
        .fav-btn.active { color: #ff4d6d; }
        
        .result-content { padding: 14px; padding-top: 26px; position: relative; background: linear-gradient(180deg, rgba(255,255,255,0.75), rgba(255,255,255,0.95)); }
        .result-content::before {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(120% 60% at 0% 0%, rgba(108,92,231,0.06), transparent 40%), radial-gradient(120% 60% at 100% 0%, rgba(165,110,255,0.06), transparent 40%);
            pointer-events: none;
        }
        
        .result-title { font-size: 1rem; margin-bottom: 6px; }
        
        .result-info { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.88rem; color: var(--gray); }
        
        .result-price {
            color: var(--accent);
            font-weight: bold;
        }
        
        .result-desc { margin-bottom: 10px; color: #555; font-size: 0.88rem; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        
        .result-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .result-rating {
            display: flex;
            align-items: center;
            gap: 5px;
            color: #f1c40f;
            font-size: 0.9rem;
        }
        
        .result-tags { display:flex; gap:6px; flex-wrap:wrap; margin-bottom:8px; }
        .result-tag { padding:5px 9px; background: var(--light); border-radius: 999px; font-size:.78rem; color: var(--gray); }
        .result-btn {
            padding: 10px 16px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--neon-2) 100%);
            color: white;
            border-radius: 24px;
            font-size: 0.92rem;
            font-weight: 800;
            border: none;
            cursor: pointer;
            box-shadow: 0 8px 18px rgba(108,92,231,0.3);
            transition: transform .2s ease;
        }
        .result-btn:active { transform: scale(0.98); }

        
        
        /* Адаптивность для очень маленьких экранов */
        @media (max-width: 1200px) {
            .content-grid {
                grid-template-columns: 1fr;
            }
            
            .sidebar-column {
                display: none;
            }
        }
        
        @media (max-width: 768px) {
            .app-container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
            }
            
            .main-content {
                margin-left: 0;
                max-width: 100%;
            }
            
            .options-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Профиль - новый дизайн */
        .profile-hero {
            position: relative;
            background: linear-gradient(120deg, var(--primary) 0%, var(--neon-2) 100%);
            border-radius: 16px;
            padding: 40px 20px 60px;
            color: white;
            overflow: hidden;
            margin-bottom: 16px;
        }
        .profile-hero::after {
            content: '';
            position: absolute;
            right: -60px;
            top: -60px;
            width: 220px;
            height: 220px;
            background: rgba(255,255,255,0.1);
            border-radius: 50%;
            filter: blur(2px);
        }
        .profile-header {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        .profile-avatar-large {
            width: 88px;
            height: 88px;
            border-radius: 50%;
            background: white;
            color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            flex: 0 0 auto;
        }
        .profile-details-block {
            flex: 1;
        }
        .profile-name {
            font-size: 1.4rem;
            font-weight: 800;
            margin-bottom: 6px;
        }
        .profile-meta {
            display: flex;
            gap: 14px;
            flex-wrap: wrap;
            opacity: 0.95;
        }
        .profile-meta span { display: inline-flex; align-items: center; gap: 8px; }
        .profile-actions {
            margin-top: 18px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .profile-btn {
            padding: 10px 16px;
            border-radius: 24px;
            border: 1px solid rgba(255,255,255,0.35);
            background: rgba(255,255,255,0.15);
            color: white;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition);
            backdrop-filter: blur(6px);
        }
        .profile-btn:hover { transform: translateY(-2px); }
        .profile-btn.primary { background: white; color: var(--primary); border-color: white; }

        .profile-stats {
            margin-top: 0;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
        }
        .stat-card {
            background: white;
            border-radius: 14px;
            padding: 16px;
            box-shadow: var(--card-shadow);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .stat-icon {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            background: var(--primary);
            flex: 0 0 auto;
        }
        .stat-title { font-size: 0.85rem; color: var(--gray); }
        .stat-value { font-size: 1.1rem; font-weight: 800; color: var(--dark); }

        .profile-menu-new { margin-top: 18px; }
        .menu-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 12px;
            border-radius: 12px;
            transition: var(--transition);
            cursor: pointer;
        }
        .menu-item + .menu-item { margin-top: 6px; }
        .menu-item:hover { background: var(--light); transform: translateY(-1px); }
        .menu-icon { width: 34px; height: 34px; border-radius: 10px; background: var(--light); display: inline-flex; align-items: center; justify-content: center; color: var(--primary); margin-right: 10px; }
        .menu-left { display: flex; align-items: center; gap: 10px; }
        .menu-text { font-weight: 700; }
        .menu-sub { font-size: 0.85rem; color: var(--gray); }
        .menu-right { color: var(--gray); }

        @media (max-width: 768px) {
            .profile-stats { grid-template-columns: 1fr; }
            .profile-header { flex-direction: column; align-items: flex-start; }
        }

        /* НОВЫЕ СТИЛИ ДЛЯ РАЗДЕЛА ОПЛАТЫ */
        .payment-container { max-width: 1000px; margin: 0 auto; }
        .payment-header { text-align: center; margin-bottom: 30px; }
        .payment-title { font-size: 2.2rem; background: linear-gradient(135deg, var(--primary) 0%, var(--neon-2) 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 10px; }
        .payment-steps { display: flex; justify-content: center; margin-bottom: 40px; position: relative; }
        .payment-steps::before { content: ''; position: absolute; top: 20px; left: 10%; right: 10%; height: 4px; background: var(--light-gray); z-index: 1; }
        .payment-step { display: flex; flex-direction: column; align-items: center; position: relative; z-index: 2; flex: 1; max-width: 200px; }
        .step-number { width: 40px; height: 40px; border-radius: 50%; background: var(--light-gray); color: var(--gray); display: flex; align-items: center; justify-content: center; font-weight: bold; margin-bottom: 10px; transition: var(--transition); }
        .payment-step.active .step-number { background: linear-gradient(135deg, var(--primary) 0%, var(--neon-2) 100%); color: white; box-shadow: 0 5px 15px rgba(108, 92, 231, 0.4); }
        .payment-step.completed .step-number { background: var(--accent); color: white; }
        .step-title { font-size: 0.9rem; font-weight: 600; text-align: center; }
        .payment-content { background: white; border-radius: 20px; padding: 30px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08); margin-bottom: 30px; }
        .cart-items { margin-bottom: 30px; }
        .cart-item { display: flex; align-items: center; padding: 20px; border: 1px solid var(--light-gray); border-radius: 12px; margin-bottom: 15px; transition: var(--transition); }
        .cart-item:hover { box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05); transform: translateY(-2px); }
        .cart-item-image { width: 80px; height: 80px; border-radius: 10px; background: linear-gradient(135deg, var(--primary) 0%, var(--neon-2) 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem; margin-right: 20px; flex-shrink: 0; }
        .cart-item-details { flex: 1; }
        .cart-item-title { font-weight: 700; margin-bottom: 5px; }
        .cart-item-info { display: flex; justify-content: space-between; color: var(--gray); font-size: 0.9rem; }
        .cart-item-price { color: var(--accent); font-weight: bold; }
        .cart-item-remove { background: none; border: none; color: var(--secondary); cursor: pointer; font-size: 1.2rem; padding: 5px; margin-left: 15px; }
        .payment-summary { background: var(--light); border-radius: 12px; padding: 20px; margin-bottom: 20px; }
        .summary-item { display: flex; justify-content: space-between; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid var(--light-gray); }
        .summary-total { display: flex; justify-content: space-between; font-weight: bold; font-size: 1.2rem; margin-top: 10px; padding-top: 10px; border-top: 2px solid var(--primary); }
        .payment-methods { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 30px; }
        .payment-method { border: 2px solid var(--light-gray); border-radius: 10px; padding: 15px; text-align: center; cursor: pointer; transition: var(--transition); }
        .payment-method:hover { border-color: var(--primary); }
        .payment-method.selected { border-color: var(--primary); background: rgba(108, 92, 231, 0.05); }
        .payment-method i { font-size: 2rem; margin-bottom: 10px; color: var(--primary); }
        .payment-form { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .payment-form .form-group { margin-bottom: 0; }
        .form-row { display: grid; grid-template-columns: 2fr 1fr; gap: 15px; }
        .pay-button { width: 100%; padding: 16px; background: linear-gradient(135deg, var(--primary) 0%, var(--neon-2) 100%); color: white; border: none; border-radius: 12px; font-size: 1.1rem; font-weight: 700; cursor: pointer; transition: var(--transition); box-shadow: 0 5px 15px rgba(108, 92, 231, 0.4); margin-top: 20px; }
        .pay-button:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(108, 92, 231, 0.5); }
        .pay-button:active { transform: translateY(0); }
        .security-note { text-align: center; margin-top: 20px; color: var(--gray); font-size: 0.9rem; }
        .security-note i { color: var(--accent); margin-right: 5px; }

        /* Партнерские блоки на главной */
        .partner-block { background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); transition: var(--transition); cursor: pointer; }
        .partner-block:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1); }
        .partner-header { display: flex; align-items: center; margin-bottom: 15px; }
        .partner-logo { width: 50px; height: 50px; border-radius: 10px; background: linear-gradient(135deg, var(--primary) 0%, var(--neon-2) 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem; margin-right: 15px; flex-shrink: 0; }
        .partner-info { flex: 1; }
        .partner-name { font-weight: 700; margin-bottom: 5px; }
        .partner-category { font-size: 0.8rem; color: var(--gray); }
        .partner-badge { background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%); color: #856404; padding: 3px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; }
        .partner-content { font-size: 0.9rem; color: #555; line-height: 1.5; }
        .partner-link { display: inline-block; margin-top: 10px; color: var(--primary); font-weight: 600; text-decoration: none; }
        .promoted-tag { background: linear-gradient(135deg, var(--secondary) 0%, #ff9e9e 100%); color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; display: inline-block; margin-left: 10px; }

        /* Stories (сторис) — ровная карусель со snap и мягкими краями */
        .stories-wrap { position: relative; }
        .stories-wrap::before, .stories-wrap::after { content:''; position:absolute; top:0; bottom:0; width:38px; pointer-events:none; z-index:2; }
        .stories-wrap::before { left:0; background: linear-gradient(90deg, rgba(255,255,255,1), rgba(255,255,255,0)); border-top-left-radius:12px; border-bottom-left-radius:12px; }
        .stories-wrap::after { right:0; background: linear-gradient(-90deg, rgba(255,255,255,1), rgba(255,255,255,0)); border-top-right-radius:12px; border-bottom-right-radius:12px; }
        .stories-ribbon { display:flex; align-items:flex-start; gap:14px; overflow-x:auto; padding:10px 8px; -webkit-overflow-scrolling:touch; scroll-snap-type: x mandatory; scroll-padding-left: 8px; }
        .stories-ribbon::-webkit-scrollbar { display:none; }
        .story-item { flex:0 0 auto; width:88px; text-align:center; cursor:pointer; scroll-snap-align:start; transition: transform .2s ease, box-shadow .2s ease; }
        .story-item:hover { transform: translateY(-2px); }
        .story-thumb { width:72px; height:72px; border-radius:50%; background: linear-gradient(135deg, var(--neon-2), var(--primary)); padding:3px; margin:0 auto 8px; position:relative; box-shadow: 0 4px 14px rgba(108,92,231,0.18); }
        .story-thumb-inner { width:100%; height:100%; border-radius:50%; background:#fff; display:flex; align-items:center; justify-content:center; font-size:26px; color: var(--primary); }
        .story-label { font-size:0.82rem; color:#2d2f3a; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; font-weight:700; }
        .story-badge { position:absolute; right:-4px; bottom:-4px; background:linear-gradient(135deg, #ff6b6b, #ff9e9e); color:#fff; font-size:10px; border-radius:10px; padding:2px 6px; box-shadow:0 2px 8px rgba(0,0,0,0.15); }

        /* Рекламные пометки и CTA в статьях */
        .sponsored-badge { display:inline-flex; align-items:center; gap:6px; background: linear-gradient(135deg, #ffd700, #ffed4e); color:#5c4b00; font-size:0.72rem; font-weight:800; border-radius:999px; padding:4px 10px; }
        .article-cta { display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border-radius:999px; background: linear-gradient(135deg, var(--primary), var(--neon-2)); color:#fff; font-weight:800; border:none; cursor:pointer; box-shadow:0 8px 18px rgba(108,92,231,0.3); }
        .article-cta:active { transform: scale(0.98); }

        /* Экран карточки кружка (детально + расписание) */
        .club-hero { position: relative; background: linear-gradient(120deg, var(--primary) 0%, var(--neon-2) 100%); border-radius: 16px; color:#fff; padding: 20px; margin-bottom: 16px; overflow: hidden; }
        .club-title { font-size: 1.4rem; font-weight: 800; margin-bottom: 6px; }
        .club-meta { display:flex; gap:12px; flex-wrap:wrap; opacity:0.95; }
        .club-meta span { display:inline-flex; align-items:center; gap:6px; background: rgba(255,255,255,0.15); border:1px solid rgba(255,255,255,0.25); padding:6px 10px; border-radius:999px; }
        .club-body { display:grid; gap:16px; }
        .club-section h3 { margin-bottom: 10px; }
        .schedule-grid { display:grid; grid-template-columns: repeat(7, 1fr); gap:10px; }
        .schedule-day { background:#fff; border:1px solid var(--light-gray); border-radius:12px; padding:10px; box-shadow: var(--card-shadow); display:flex; flex-direction:column; gap:8px; }
        .schedule-day-title { font-weight:800; font-size:0.92rem; color: var(--dark); }
        .slot { padding:8px 10px; border:1px solid var(--light-gray); border-radius:999px; font-size:0.9rem; cursor:pointer; text-align:center; background: var(--light); }
        .slot:hover { background:#fff; }
        .slot.selected { border-color: var(--primary); background: rgba(108,92,231,0.08); color: var(--primary-dark); font-weight:700; }
        .club-actions { display:flex; gap:10px; flex-wrap:wrap; }
        .club-btn { padding:12px 16px; border-radius:12px; border:1px solid var(--light-gray); background:#fff; cursor:pointer; font-weight:800; }
        .club-btn.primary { background: linear-gradient(135deg, var(--primary), var(--neon-2)); color:#fff; border:none; box-shadow:0 8px 18px rgba(108,92,231,0.3); }
        .club-btn:disabled { opacity:0.6; cursor:not-allowed; }
        @media (max-width: 992px) { .schedule-grid { grid-template-columns: repeat(3, 1fr); } }
        @media (max-width: 600px) { .schedule-grid { grid-template-columns: repeat(2, 1fr); } }

        /* Чаты */
        .chats-container { display:grid; grid-template-columns: 320px 1fr; gap:12px; }
        @media (max-width: 980px) { .chats-container { grid-template-columns: 1fr; } }
        .chat-list { padding:0; }
        .chat-item { display:flex; align-items:center; gap:10px; padding:12px; border-bottom:1px solid var(--light-gray); cursor:pointer; transition: var(--transition); }
        .chat-item:hover { background: var(--light); }
        .chat-avatar { width:42px; height:42px; border-radius:50%; background: var(--primary); color:#fff; display:flex; align-items:center; justify-content:center; }
        .chat-main { flex:1; }
        .chat-name { font-weight:800; font-size:0.98rem; }
        .chat-last { color: var(--gray); font-size:0.86rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
        .chat-badge { background: var(--secondary); color:#fff; font-size:0.72rem; border-radius:999px; padding:2px 8px; }
        .chat-meta { display:flex; flex-direction:column; align-items:flex-end; gap:6px; }
        .chat-thread { display:flex; flex-direction:column; height: 560px; }
        .chat-thread-header { padding:10px 12px; border-bottom:1px solid var(--light-gray); display:flex; align-items:center; justify-content:space-between; }
        .chat-title { font-weight:800; }
        .chat-messages { flex:1; padding:12px; overflow:auto; display:flex; flex-direction:column; gap:10px; background: linear-gradient(180deg, #ffffff, #fbfcff); border-radius:12px; }
        .msg { max-width: 78%; padding:10px 12px; border-radius:14px; box-shadow: var(--card-shadow); font-size:0.95rem; line-height:1.35; }
        .msg.user { align-self:flex-end; background: linear-gradient(135deg, var(--primary), var(--neon-2)); color:#fff; border-bottom-right-radius:6px; }
        .msg.club { align-self:flex-start; background:#fff; border:1px solid var(--light-gray); border-bottom-left-radius:6px; }
        .msg-time { display:block; margin-top:6px; font-size:0.75rem; opacity:0.8; }
        .chat-quick { padding:8px 12px; display:flex; gap:8px; flex-wrap:wrap; border-top:1px dashed var(--light-gray); }
        .chat-input { display:flex; gap:8px; padding:10px; border-top:1px solid var(--light-gray); }
        .chat-input textarea { flex:1; min-height:46px; max-height:120px; padding:10px 12px; border:1px solid var(--light-gray); border-radius:10px; resize:vertical; }
        .chat-send { padding:0 14px; background: linear-gradient(135deg, var(--primary), var(--neon-2)); color:#fff; border:none; border-radius:10px; font-weight:800; cursor:pointer; }

        /* Предтестовая магия внутри волнового блока */
        .magic-overlay { position:absolute; inset:0; display:flex; align-items:center; justify-content:center; z-index:3; pointer-events:none; }
        .magic-core { position:relative; width:160px; height:160px; border-radius:50%; background: radial-gradient(circle at 50% 50%, rgba(255,255,255,0.25), rgba(255,255,255,0.05)); box-shadow: 0 0 40px rgba(255,255,255,0.25), inset 0 0 30px rgba(255,255,255,0.15); }
        .ring { position:absolute; inset:-10px; border-radius:50%; border:2px dashed rgba(255,255,255,0.5); animation: spin 1.8s linear infinite; }
        .ring.r2 { inset:-22px; border-color: rgba(0,255,240,0.6); animation-duration: 2.4s; }
        .ring.r3 { inset:-34px; border-color: rgba(165,110,255,0.6); animation-duration: 3s; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .spark { position:absolute; width:6px; height:6px; background: radial-gradient(circle, #fff, rgba(255,255,255,0.1)); border-radius:50%; animation: sparkUp 1.2s ease-out forwards; }
        @keyframes sparkUp { 0% { transform: translateY(0) scale(0.6); opacity:0.9; } 100% { transform: translateY(-120px) scale(1); opacity:0; } }

        /* Полноэкранная пре-анимация перед тестом */
        .pretest-overlay { position: fixed; inset: 0; z-index: 2500; display: none; align-items: center; justify-content: center; flex-direction: column; }
        .pretest-bg { position:absolute; inset:0; background:
            radial-gradient(120% 80% at 0% 0%, rgba(108,92,231,0.18), transparent 40%),
            radial-gradient(120% 80% at 100% 0%, rgba(165,110,255,0.18), transparent 40%),
            linear-gradient(180deg, #0f1222, #171b2e);
            overflow:hidden;
        }
        .pretest-grid { position:absolute; inset:0; background-image: linear-gradient(rgba(255,255,255,0.06) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.06) 1px, transparent 1px); background-size: 40px 40px; opacity:0.25; filter: blur(0.2px); }
        .pretest-core { position:relative; width: 200px; height: 200px; border-radius: 50%; background: radial-gradient(circle, rgba(124,243,255,0.15), rgba(124,243,255,0.02)); box-shadow: 0 0 60px rgba(124,243,255,0.35), inset 0 0 40px rgba(124,243,255,0.22); }
        .pre-ring { position:absolute; inset:-14px; border-radius:50%; border:2px solid rgba(124,243,255,0.65); filter: drop-shadow(0 0 14px rgba(124,243,255,0.45)); animation: preSpin 2.2s linear infinite; }
        .pre-ring.r2 { inset:-30px; border-color: rgba(165,110,255,0.65); animation-duration: 3s; }
        .pre-ring.r3 { inset:-46px; border-color: rgba(0,209,178,0.65); animation-duration: 3.8s; }
        @keyframes preSpin { to { transform: rotate(360deg); } }
        .pre-spark { position:absolute; width:8px; height:8px; border-radius:50%; background: radial-gradient(circle, #fff, rgba(255,255,255,0)); animation: preBurst 1.6s ease-out forwards; }
        @keyframes preBurst { 0% { transform: translate(0) scale(0.5); opacity:0.95;} 100% { transform: translate(var(--dx), var(--dy)) scale(1); opacity:0; } }
        .pretest-text { position: relative; margin-top: 24px; color: #d9f7ff; font-weight: 800; font-size: 1.2rem; text-shadow: 0 0 10px rgba(124,243,255,0.35); letter-spacing: .3px; }

        /* Мои дети */
        .kids-grid { display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap:12px; }
        @media (max-width: 1100px) { .kids-grid { grid-template-columns: repeat(2, minmax(0,1fr)); } }
        @media (max-width: 700px) { .kids-grid { grid-template-columns: 1fr; } }
        .kid-card { background:#fff; border-radius:14px; padding:14px; box-shadow: var(--card-shadow); border:1px solid var(--light-gray); cursor:pointer; transition: transform .15s ease, box-shadow .15s ease; }
        .kid-card:hover { transform: translateY(-2px); box-shadow: 0 10px 22px rgba(0,0,0,0.08); }
        .kid-row { display:flex; align-items:center; gap:12px; margin-bottom:8px; }
        .kid-avatar { width:48px; height:48px; border-radius:50%; background: linear-gradient(135deg, var(--primary), var(--neon-2)); color:#fff; display:flex; align-items:center; justify-content:center; font-weight:800; }
        .kid-title { font-weight:800; }
        .kid-sub { color: var(--gray); font-size:0.9rem; }
        .progress-rows { display:grid; gap:8px; }
        .progress-row { display:flex; align-items:center; gap:10px; }
        .progress-bar-thin { flex:1; height:8px; background: var(--light); border-radius:999px; position:relative; overflow:hidden; }
        .progress-bar-thin > span { position:absolute; left:0; top:0; bottom:0; background: linear-gradient(90deg, var(--primary), var(--neon-2)); border-radius:999px; width:0%; }
        /* удалены стили домашек */
    </style>
</head>
<body>
    <!-- Экран онбординга -->
    <div class="onboarding-container" id="onboarding-container">
        <div class="onboarding-slides" id="onboarding-slides">
            <!-- Первый экран -->
            <div class="onboarding-slide" id="onboarding-slide-0">
                <div class="onboarding-image"><i class="fas fa-child"></i></div>
                <h2 class="onboarding-title">Добро пожаловать в KIDCIRCLE</h2>
                <p class="onboarding-text">Платформа для поиска детских кружков и секций в вашем городе</p>
                <button class="onboarding-btn" onclick="nextOnboardingSlide(1)">Далее</button>
                <button class="onboarding-btn skip" onclick="skipOnboarding()">Пропустить</button>
            </div>
            <!-- Второй экран -->
            <div class="onboarding-slide" id="onboarding-slide-1">
                <div class="onboarding-image"><i class="fas fa-search"></i></div>
                <h2 class="onboarding-title">Найдите идеальный кружок</h2>
                <p class="onboarding-text">Мы собрали сотни кружков и секций для детей всех возрастов</p>
                <button class="onboarding-btn" onclick="nextOnboardingSlide(2)">Далее</button>
                <button class="onboarding-btn skip" onclick="skipOnboarding()">Пропустить</button>
            </div>
            <!-- Третий экран -->
            <div class="onboarding-slide" id="onboarding-slide-2">
                <div class="onboarding-image"><i class="fas fa-robot"></i></div>
                <h2 class="onboarding-title">Тест способностей с ИИ</h2>
                <p class="onboarding-text">Пройдите тест, и мы подберем кружки, подходящие вашему ребенку</p>
                <button class="onboarding-btn" onclick="nextOnboardingSlide(3)">Далее</button>
                <button class="onboarding-btn skip" onclick="skipOnboarding()">Пропустить</button>
            </div>
            <!-- Четвертый экран -->
            <div class="onboarding-slide" id="onboarding-slide-3">
                <div class="onboarding-image"><i class="fas fa-calendar-check"></i></div>
                <h2 class="onboarding-title">Записывайтесь онлайн</h2>
                <p class="onboarding-text">Выбирайте подходящее время и записывайтесь на занятия в несколько кликов</p>
                <button class="onboarding-btn" onclick="nextOnboardingSlide(4)">Далее</button>
                <button class="onboarding-btn skip" onclick="skipOnboarding()">Пропустить</button>
            </div>
            <!-- Экран ввода имени -->
            <div class="onboarding-slide" id="onboarding-slide-4">
                <div class="form-container">
                    <label for="user-name" class="form-label">Ваше имя</label>
                    <input type="text" id="user-name" class="form-input" placeholder="Введите имя" value="">
                    <button class="form-btn" onclick="nextOnboardingSlide(5)">Далее</button>
                </div>
            </div>
            <!-- Экран ввода города -->
            <div class="onboarding-slide" id="onboarding-slide-5">
                <div class="form-container">
                    <label for="user-city" class="form-label">Ваш город</label>
                    <input type="text" id="user-city" class="form-input" placeholder="Введите город" value="">
                    <button class="form-btn" onclick="nextOnboardingSlide(6)">Далее</button>
                </div>
            </div>
            <!-- Экран ввода телефона -->
            <div class="onboarding-slide" id="onboarding-slide-6">
                <div class="form-container">
                    <label for="user-phone" class="form-label">Телефон</label>
                    <input type="tel" id="user-phone" class="form-input" placeholder="+7 (___) ___-__-__" value="">
                    <button class="form-btn" onclick="sendVerificationCode()">Получить код</button>
                </div>
            </div>
            <!-- Экран подтверждения номера -->
            <div class="onboarding-slide" id="onboarding-slide-7">
                <div class="form-container">
                    <p>Введите код, отправленный на номер <span id="phone-number"></span></p>
                    <div class="code-inputs">
                        <input type="text" maxlength="1" class="code-input" oninput="moveToNext(this, 1)">
                        <input type="text" maxlength="1" class="code-input" oninput="moveToNext(this, 2)">
                        <input type="text" maxlength="1" class="code-input" oninput="moveToNext(this, 3)">
                        <input type="text" maxlength="1" class="code-input" oninput="moveToNext(this, 4)">
                    </div>
                    <p class="timer-text">Отправить код повторно через <span id="timer">59</span> секунд</p>
                    <a href="#" class="resend-link" id="resend-link" style="display:none;" onclick="resendCode()">Отправить код повторно</a>
                    <button class="form-btn" onclick="verifyCode()">Подтвердить</button>
                </div>
            </div>
        </div>
    </div>

    <div class="app-container">
        <!-- Левое меню -->
        <div class="sidebar">
            <div class="logo-section">
                <i class="fas fa-child logo-icon"></i>
                <span>KIDCIRCLE</span>
            </div>
            
            <div class="nav-section">
                <div class="nav-item active" data-screen="home-screen">
                    <i class="fas fa-home nav-icon"></i>
                    <span class="nav-text">Главная</span>
                </div>
                <div class="nav-item" data-screen="search-screen">
                    <i class="fas fa-search nav-icon"></i>
                    <span class="nav-text">Поиск кружков</span>
                </div>
                <div class="nav-item" data-screen="favorites-screen">
                    <i class="fas fa-heart nav-icon"></i>
                    <span class="nav-text">Избранное</span>
                </div>
                <div class="nav-item" data-screen="records-screen">
                    <i class="fas fa-history nav-icon"></i>
                    <span class="nav-text">Мои записи</span>
                </div>
                <div class="nav-item" data-screen="pay-screen">
                    <i class="fas fa-credit-card nav-icon"></i>
                    <span class="nav-text">Оплата</span>
                </div>
                <div class="nav-item" data-screen="kids-screen">
                    <i class="fas fa-children nav-icon"></i>
                    <span class="nav-text">Мои дети</span>
                </div>
                <div class="nav-item" data-screen="chats-screen">
                    <i class="fas fa-comments nav-icon"></i>
                    <span class="nav-text">Чаты</span>
                </div>
            </div>
            
            <div class="user-section">
                <div class="user-avatar">
                    <i class="fas fa-user"></i>
                </div>
                <div class="user-info">
                    <div class="user-name" id="sidebar-user-name">Имя пользователя</div>
                    <div class="user-city" id="sidebar-user-city">Город</div>
                </div>
            </div>
        </div>
        
        <!-- Основной контент -->
        <div class="main-content">
            <!-- Главный экран -->
            <div class="screen active" id="home-screen">
                <!-- Секция теста с анимацией волны -->
                <div class="test-section">
                    
                    <div class="wave-container">
                    <div class="magic-overlay" id="pretest-magic" style="display:none;">
                        <div class="magic-core">
                            <div class="ring"></div>
                            <div class="ring r2"></div>
                            <div class="ring r3"></div>
                        </div>
                    </div>
                        <div class="overlay-top"></div>
                        <div class="wave"></div>
                        <div class="wave"></div>
                        <div class="wave"></div>
                        <div class="crest-overlay"></div>
                        <div class="wave-content">
                            <div class="wave-title">Найдите идеальный кружок</div>
                            <div class="wave-subtitle">Искусственный интеллект подберет варианты на основе интересов вашего ребенка</div>
                            <a href="#" class="start-test-btn" id="start-test-btn">Начать тест</a>
                        </div>
                        <!-- bubbles -->
                        <div class="bubble small" style="left:10%; animation-delay: 0s;"></div>
                        <div class="bubble mid" style="left:22%; animation-delay: .8s;"></div>
                        <div class="bubble big" style="left:35%; animation-delay: .2s;"></div>
                        <div class="bubble mid" style="left:48%; animation-delay: 1.2s;"></div>
                        <div class="bubble small" style="left:60%; animation-delay: .4s;"></div>
                        <div class="bubble big" style="left:72%; animation-delay: 1.6s;"></div>
                        <div class="bubble small" style="left:84%; animation-delay: .6s;"></div>
                    </div>
                    
                    <div class="promo-blocks">
                        <div class="promo-block">
                            <div class="promo-title">Топ кружки</div>
                            <div class="promo-subtitle">Лучшие секции для развития талантов</div>
                            <div class="promo-icon"><i class="fas fa-trophy"></i></div>
                        </div>
                        <div class="promo-block">
                            <div class="promo-title">Популярное</div>
                            <div class="promo-subtitle">Самые востребованные кружки города</div>
                            <div class="promo-icon"><i class="fas fa-fire"></i></div>
                        </div>
                        <div class="promo-block">
                            <div class="promo-title">Для малышей</div>
                            <div class="promo-subtitle">Кружки для детей 3-6 лет</div>
                            <div class="promo-icon"><i class="fas fa-baby"></i></div>
                        </div>
                        <div class="promo-block">
                            <div class="promo-title">Для школьников</div>
                            <div class="promo-subtitle">Секции для детей 7-14 лет</div>
                            <div class="promo-icon"><i class="fas fa-graduation-cap"></i></div>
                        </div>
                    </div>
                </div>
                
                <div class="content-grid">
                    <div class="main-column">
                        <!-- Сторис -->
                        <div class="content-card stories-wrap">
                            <div class="stories-ribbon">
                                <div class="story-item is-large" data-story="sport">
                                    <div class="story-thumb"><div class="story-thumb-inner"><i class="fas fa-futbol"></i></div><span class="story-badge">New</span></div>
                                    <div class="story-label">Футбол детям</div>
                                </div>
                                <div class="story-item" data-story="creativity">
                                    <div class="story-thumb"><div class="story-thumb-inner"><i class="fas fa-paint-brush"></i></div></div>
                                    <div class="story-label">Идеи для рисования</div>
                                </div>
                                <div class="story-item" data-story="robotics">
                                    <div class="story-thumb"><div class="story-thumb-inner"><i class="fas fa-robot"></i></div></div>
                                    <div class="story-label">Первый робот</div>
                                </div>
                                <div class="story-item is-large" data-story="music">
                                    <div class="story-thumb"><div class="story-thumb-inner"><i class="fas fa-music"></i></div></div>
                                    <div class="story-label">С чего начать музыку</div>
                                </div>
                                <div class="story-item" data-story="dance">
                                    <div class="story-thumb"><div class="story-thumb-inner"><i class="fas fa-person-running"></i></div></div>
                                    <div class="story-label">Движение и здоровье</div>
                                </div>
                                <div class="story-item" data-story="nature">
                                    <div class="story-thumb"><div class="story-thumb-inner"><i class="fas fa-leaf"></i></div></div>
                                    <div class="story-label">Природа и дети</div>
                                </div>
                                <div class="story-item" data-story="coding">
                                    <div class="story-thumb"><div class="story-thumb-inner"><i class="fas fa-code"></i></div></div>
                                    <div class="story-label">Первые строки кода</div>
                                </div>
                            </div>
                        </div>

                        <div class="content-card">
                            <h3 class="section-title">Популярные статьи <a href="#" class="view-all">Смотреть все</a></h3>
                            <div class="articles-grid">
                                <div class="article-card">
                                    <div class="article-image">
                                        Как выбрать кружок
                                        <div class="article-badge">Совет</div>
                                    </div>
                                    <div class="article-content">
                                        <h4 class="article-title">Как выбрать кружок для ребенка: 7 важных критериев</h4>
                                        <p class="article-excerpt">Узнайте, на что обратить внимание при выборе секции для вашего ребенка.</p>
                                        <div class="article-meta">
                                            <span><i class="far fa-clock"></i> 2 дня назад</span>
                                            <span><i class="far fa-eye"></i> 1.4K</span>
                                        </div>
                                        <div style="display:flex; align-items:center; justify-content:space-between; margin-top:10px;">
                                            <span class="sponsored-badge"><i class="fas fa-bullhorn"></i> Реклама</span>
                                            <button class="article-cta" data-cta="sport_champion"><i class="fas fa-futbol"></i> Записаться в футбол</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="article-card">
                                    <div class="article-image">
                                        Топ-5 кружков
                                        <div class="article-badge">Обзор</div>
                                    </div>
                                    <div class="article-content">
                                        <h4 class="article-title">Топ-5 развивающих кружков для детей 5-7 лет</h4>
                                        <p class="article-excerpt">Мы собрали лучшие кружки для дошкольников.</p>
                                        <div class="article-meta">
                                            <span><i class="far fa-clock"></i> 5 дней назад</span>
                                            <span><i class="far fa-eye"></i> 2.8K</span>
                                        </div>
                                        <div style="display:flex; align-items:center; justify-content:flex-end; margin-top:10px;">
                                            <button class="article-cta" data-cta="develop_start"><i class="fas fa-seedling"></i> Подобрать развивашку</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="article-card">
                                    <div class="article-image">
                                        Баланс учебы
                                        <div class="article-badge">Психология</div>
                                    </div>
                                    <div class="article-content">
                                        <h4 class="article-title">Как совмещать школу и дополнительные занятия без стресса</h4>
                                        <p class="article-excerpt">Практические рекомендации по составлению расписания.</p>
                                        <div class="article-meta">
                                            <span><i class="far fa-clock"></i> 1 неделю назад</span>
                                            <span><i class="far fa-eye"></i> 3.5K</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="article-card">
                                    <div class="article-image">
                                        Успех в робототехнике
                                        <div class="article-badge">Вдохновение</div>
                                    </div>
                                    <div class="article-content">
                                        <h4 class="article-title">Как 10-летний Миша стал призером всероссийского конкурса</h4>
                                        <p class="article-excerpt">История мальчика, который начал с простых конструкторов.</p>
                                        <div class="article-meta">
                                            <span><i class="far fa-clock"></i> 2 недели назад</span>
                                            <span><i class="far fa-eye"></i> 5.2K</span>
                                        </div>
                                        <div style="display:flex; align-items:center; justify-content:flex-end; margin-top:10px;">
                                            <button class="article-cta" data-cta="robotics"><i class="fas fa-robot"></i> На занятие по робототехнике</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="sidebar-column">
                        <!-- Партнеры -->
                        <div class="content-card">
                            <h3 class="section-title">Рекомендуемые партнеры <span class="promoted-tag">ПРЕМИУМ</span></h3>
                            <div class="partner-block">
                                <div class="partner-header">
                                    <div class="partner-logo"><i class="fas fa-robot"></i></div>
                                    <div class="partner-info">
                                        <div class="partner-name">Академия робототехники</div>
                                        <div class="partner-category">Наука и технологии</div>
                                    </div>
                                    <div class="partner-badge">Топ партнер</div>
                                </div>
                                <div class="partner-content">Современные курсы робототехники для детей от 6 лет. Скидка 15% для новых клиентов.</div>
                                <a href="#" class="partner-link">Узнать больше →</a>
                            </div>
                            <div class="partner-block">
                                <div class="partner-header">
                                    <div class="partner-logo"><i class="fas fa-paint-brush"></i></div>
                                    <div class="partner-info">
                                        <div class="partner-name">Студия творчества "Арт-Кид"</div>
                                        <div class="partner-category">Искусство и творчество</div>
                                    </div>
                                </div>
                                <div class="partner-content">Рисование, лепка, дизайн для детей всех возрастов. Первое занятие бесплатно!</div>
                                <a href="#" class="partner-link">Узнать больше →</a>
                            </div>
                        </div>

                        <!-- Акции -->
                        <div class="content-card">
                            <h3 class="section-title">Акции и скидки <span class="promoted-tag">ВЫГОДНО</span></h3>
                            <div class="partner-block">
                                <div class="partner-header">
                                    <div class="partner-logo"><i class="fas fa-swimmer"></i></div>
                                    <div class="partner-info">
                                        <div class="partner-name">Бассейн "Дельфин"</div>
                                        <div class="partner-category">Спорт и здоровье</div>
                                    </div>
                                </div>
                                <div class="partner-content">Скидка 20% на абонемент по плаванию для детей до 10 лет. Акция действует до конца месяца.</div>
                                <a href="#" class="partner-link">Узнать больше →</a>
                            </div>
                            <div class="partner-block">
                                <div class="partner-header">
                                    <div class="partner-logo"><i class="fas fa-music"></i></div>
                                    <div class="partner-info">
                                        <div class="partner-name">Музыкальная школа "Виртуоз"</div>
                                        <div class="partner-category">Музыка и вокал</div>
                                    </div>
                                </div>
                                <div class="partner-content">Бесплатный пробный урок по фортепиано или гитаре. Запишитесь до конца недели!</div>
                                <a href="#" class="partner-link">Узнать больше →</a>
                            </div>
                        </div>

                        <!-- События -->
                        <div class="content-card">
                            <h3 class="section-title">Ближайшие мероприятия <span class="promoted-tag">СОБЫТИЯ</span></h3>
                            <div class="partner-block">
                                <div class="partner-header">
                                    <div class="partner-logo"><i class="fas fa-theater-masks"></i></div>
                                    <div class="partner-info">
                                        <div class="partner-name">Фестиваль детского творчества</div>
                                        <div class="partner-category">Мероприятие</div>
                                    </div>
                                </div>
                                <div class="partner-content">Примите участие в городском фестивале детского творчества. Регистрация открыта до 15 числа.</div>
                                <a href="#" class="partner-link">Узнать больше →</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Экран теста -->
            <div class="test-screen" id="test-screen">
                <div class="test-card">
                <div class="test-header">
                    <h2 class="test-title">Тест способностей с ИИ</h2>
                    <button class="nav-btn prev" id="close-test-btn">Закрыть</button>
                </div>
                <div class="test-progress">
                    <div class="progress-bar" id="progress-bar" style="width: 20%"></div>
                </div>
                <div class="question-text" id="question-text">Что больше всего нравится делать вашему ребенку в свободное время?</div>
                <div class="options-grid" id="options-grid">
                    <!-- Варианты ответов будут добавляться через JS -->
                </div>
                <div class="test-nav">
                    <button class="nav-btn prev" id="prev-btn">Назад</button>
                    <button class="nav-btn next" id="next-btn">Далее</button>
                    </div>
                </div>
            </div>

            <!-- Экран результатов теста -->
            <div class="results-screen" id="results-screen">
                <div class="results-card">
                <div class="test-header">
                    <h2 class="test-title">Результаты теста</h2>
                    <button class="nav-btn prev" id="close-results-btn">Закрыть</button>
                </div>
                <p class="test-desc">На основе ответов мы подобрали подходящие кружки</p>
                <div id="results-container"></div>
                </div>
            </div>
            
            <!-- Экран поиска -->
            <div class="screen" id="search-screen">
                <div class="search-header">
                    <div class="search-input-container">
                        <input type="text" class="search-input" placeholder="Поиск кружков и секций...">
                        <i class="fas fa-search search-icon"></i>
                    </div>
                    <div class="filter-icon">
                        <i class="fas fa-filter"></i>
                    </div>
                </div>
                <div class="search-filters">
                    <button class="filter-chip active">Все</button>
                    <button class="filter-chip">Спорт</button>
                    <button class="filter-chip">Творчество</button>
                    <button class="filter-chip">Наука</button>
                    <button class="filter-chip">Музыка</button>
                    <button class="filter-chip">Танцы</button>
                    <button class="filter-chip">Развитие</button>
                </div>
                <h2 class="section-title" style="margin-top:24px;">Все кружки</h2>
                <div class="search-results">
                    <!-- Спорт -->
                    <div class="result-card">
                        <button class="fav-btn" aria-label="Добавить в избранное"><i class="fas fa-heart"></i></button>
                        <div class="result-image" style="background: linear-gradient(120deg, #00c6ff 0%, #0072ff 100%);"><span class="result-icon"><i class="fas fa-futbol"></i></span>Спорт<div class="result-badge badge-premium"><span>Премиум</span></div><button class="fav-btn" data-id="sport_champion" aria-label="Добавить в избранное"><i class="fas fa-heart"></i></button></div>
                        <div class="result-content">
                            <h3 class="result-title">Футбольная академия "Чемпион"</h3>
                            <div class="result-info"><span>7-12 лет</span><span class="result-price">2000₽/мес</span></div>
                            <div class="result-tags"><span class="result-tag">Командная игра</span><span class="result-tag">Физподготовка</span></div>
                            <p class="result-desc">Профессиональные тренировки по футболу: техника, координация и командный дух.</p>
                            <div class="result-footer"><div class="result-rating"><i class="fas fa-star"></i><span>4.9 (128)</span></div><button class="result-btn" data-id="sport_champion">Записаться</button></div>
                        </div>
                    </div>
                    <!-- Творчество -->
                    <div class="result-card">
                        <button class="fav-btn" aria-label="Добавить в избранное"><i class="fas fa-heart"></i></button>
                        <div class="result-image" style="background: linear-gradient(120deg, #f857a6 0%, #ff5858 100%);"><span class="result-icon"><i class="fas fa-palette"></i></span>Творчество<div class="result-badge badge-new"><span>Новое</span></div><button class="fav-btn" data-id="art_class" aria-label="Добавить в избранное"><i class="fas fa-heart"></i></button></div>
                        <div class="result-content">
                            <h3 class="result-title">Студия рисования "Арт-Класс"</h3>
                            <div class="result-info"><span>5-16 лет</span><span class="result-price">1800₽/мес</span></div>
                            <div class="result-tags"><span class="result-tag">Акварель</span><span class="result-tag">Гуашь</span><span class="result-tag">Скетчинг</span></div>
                            <p class="result-desc">Учим видеть форму и цвет, развиваем воображение и художественный вкус.</p>
                            <div class="result-footer"><div class="result-rating"><i class="fas fa-star"></i><span>4.7 (87)</span></div><button class="result-btn" data-id="art_class">Записаться</button></div>
                        </div>
                    </div>
                    <!-- Наука -->
                    <div class="result-card">
                        <button class="fav-btn" aria-label="Добавить в избранное"><i class="fas fa-heart"></i></button>
                        <div class="result-image" style="background: linear-gradient(120deg, #00b09b 0%, #96c93d 100%);"><span class="result-icon"><i class="fas fa-robot"></i></span>Наука<div class="result-badge badge-premium"><span>Премиум</span></div><button class="fav-btn" data-id="robotics" aria-label="Добавить в избранное"><i class="fas fa-heart"></i></button></div>
                        <div class="result-content">
                            <h3 class="result-title">Робототехника для детей</h3>
                            <div class="result-info"><span>8-14 лет</span><span class="result-price">2500₽/мес</span></div>
                            <div class="result-tags"><span class="result-tag">LEGO</span><span class="result-tag">Arduino</span><span class="result-tag">Код</span></div>
                            <p class="result-desc">Создаём роботов, программируем датчики и механизмы, развиваем логическое мышление.</p>
                            <div class="result-footer"><div class="result-rating"><i class="fas fa-star"></i><span>4.8 (96)</span></div><button class="result-btn" data-id="robotics">Записаться</button></div>
                        </div>
                    </div>
                    <!-- Музыка -->
                    <div class="result-card">
                        <button class="fav-btn" aria-label="Добавить в избранное"><i class="fas fa-heart"></i></button>
                        <div class="result-image" style="background: linear-gradient(120deg, #8E2DE2 0%, #4A00E0 100%);"><span class="result-icon"><i class="fas fa-music"></i></span>Музыка<div class="result-badge badge-new"><span>Новое</span></div><button class="fav-btn" data-id="music_forte" aria-label="Добавить в избранное"><i class="fas fa-heart"></i></button></div>
                        <div class="result-content">
                            <h3 class="result-title">Школа музыки "Форте"</h3>
                            <div class="result-info"><span>6-15 лет</span><span class="result-price">2300₽/мес</span></div>
                            <div class="result-tags"><span class="result-tag">Фортепиано</span><span class="result-tag">Гитара</span><span class="result-tag">Вокал</span></div>
                            <p class="result-desc">Занятия с профессиональными педагогами, сцена и поддержка на конкурсах.</p>
                            <div class="result-footer"><div class="result-rating"><i class="fas fa-star"></i><span>4.9 (142)</span></div><button class="result-btn" data-id="music_forte">Записаться</button></div>
                        </div>
                    </div>
                    <!-- Танцы -->
                    <div class="result-card">
                        <button class="fav-btn" aria-label="Добавить в избранное"><i class="fas fa-heart"></i></button>
                        <div class="result-image" style="background: linear-gradient(120deg, #FF416C 0%, #FF4B2B 100%);"><span class="result-icon"><i class="fas fa-person-running"></i></span>Танцы<div class="result-badge badge-premium"><span>Премиум</span></div><button class="fav-btn" data-id="dance_grace" aria-label="Добавить в избранное"><i class="fas fa-heart"></i></button></div>
                        <div class="result-content">
                            <h3 class="result-title">Танцевальная студия "Грация"</h3>
                            <div class="result-info"><span>4-15 лет</span><span class="result-price">2200₽/мес</span></div>
                            <div class="result-tags"><span class="result-tag">Хип-хоп</span><span class="result-tag">Классика</span></div>
                            <p class="result-desc">Современные и классические направления, выступления и фестивали.</p>
                            <div class="result-footer"><div class="result-rating"><i class="fas fa-star"></i><span>4.8 (112)</span></div><button class="result-btn" data-id="dance_grace">Записаться</button></div>
                        </div>
                    </div>
                    <!-- Развитие -->
                    <div class="result-card">
                        <button class="fav-btn" aria-label="Добавить в избранное"><i class="fas fa-heart"></i></button>
                        <div class="result-image" style="background: linear-gradient(120deg, #11998E 0%, #38EF7D 100%);"><span class="result-icon"><i class="fas fa-seedling"></i></span>Развитие<div class="result-badge badge-new"><span>Новое</span></div><button class="fav-btn" data-id="develop_start" aria-label="Добавить в избранное"><i class="fas fa-heart"></i></button></div>
                        <div class="result-content">
                            <h3 class="result-title">Развивающий центр "Старт"</h3>
                            <div class="result-info"><span>3-7 лет</span><span class="result-price">1700₽/мес</span></div>
                            <div class="result-tags"><span class="result-tag">Логика</span><span class="result-tag">Память</span><span class="result-tag">Речь</span></div>
                            <p class="result-desc">Игровые занятия для гармоничного развития: моторика, речь, внимание.</p>
                            <div class="result-footer"><div class="result-rating"><i class="fas fa-star"></i><span>4.6 (73)</span></div><button class="result-btn" data-id="develop_start">Записаться</button></div>
                            </div>
                            </div>
                        </div>
                    </div>
                    
            <!-- Экран избранного -->
            <div class="screen" id="favorites-screen">
                <h2 style="margin-bottom: 14px;">Избранное</h2>
                <div id="favorites-list" class="search-results"></div>
            </div>

            <!-- Экран профессиональных фильтров -->
            <div class="screen" id="filters-screen">
                <div class="content-card" style="margin-bottom:16px; display:flex; align-items:center; justify-content:space-between; gap:10px;">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <button class="nav-btn prev" id="filters-back-btn"><i class="fas fa-arrow-left"></i></button>
                        <h2 class="section-title" style="margin:0;">Профессиональные фильтры</h2>
                    </div>
                    <button class="nav-btn" id="filters-reset-btn">Сбросить</button>
                </div>
                <div class="content-card">
                    <h3 style="margin-bottom:12px;">Направление</h3>
                    <div class="search-filters" id="filters-direction">
                        <button class="filter-chip" data-filter="direction:sport">Спорт</button>
                        <button class="filter-chip" data-filter="direction:creative">Творчество</button>
                        <button class="filter-chip" data-filter="direction:science">Наука</button>
                        <button class="filter-chip" data-filter="direction:music">Музыка</button>
                        <button class="filter-chip" data-filter="direction:dance">Танцы</button>
                        <button class="filter-chip" data-filter="direction:develop">Развитие</button>
                    </div>

                    <h3 style="margin:16px 0 12px;">Возраст</h3>
                    <div class="search-filters" id="filters-age">
                        <button class="filter-chip" data-filter="age:3-5">3-5</button>
                        <button class="filter-chip" data-filter="age:6-8">6-8</button>
                        <button class="filter-chip" data-filter="age:9-11">9-11</button>
                        <button class="filter-chip" data-filter="age:12-14">12-14</button>
                        <button class="filter-chip" data-filter="age:15-17">15-17</button>
                    </div>

                    <h3 style="margin:16px 0 12px;">Уровень</h3>
                    <div class="search-filters" id="filters-level">
                        <button class="filter-chip" data-filter="level:beginner">Начальный</button>
                        <button class="filter-chip" data-filter="level:intermediate">Средний</button>
                        <button class="filter-chip" data-filter="level:advanced">Продвинутый</button>
                    </div>

                    <h3 style="margin:16px 0 12px;">Формат</h3>
                    <div class="search-filters" id="filters-format">
                        <button class="filter-chip" data-filter="format:group">Групповые</button>
                        <button class="filter-chip" data-filter="format:1-1">Индивидуальные</button>
                        <button class="filter-chip" data-filter="format:online">Онлайн</button>
                        <button class="filter-chip" data-filter="format:offline">Очно</button>
                    </div>

                    <h3 style="margin:16px 0 12px;">Цены</h3>
                    <div style="display:grid; gap:10px; max-width:420px;">
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                            <input id="price-min" type="number" class="form-input" placeholder="Мин, ₽" min="0">
                            <input id="price-max" type="number" class="form-input" placeholder="Макс, ₽" min="0">
                        </div>
                        <div class="search-filters" id="filters-price-presets">
                            <button class="filter-chip" data-filter="price:<2000">< 2000</button>
                            <button class="filter-chip" data-filter="price:2000-3000">2000–3000</button>
                            <button class="filter-chip" data-filter="price:>3000">> 3000</button>
                        </div>
                    </div>

                    <h3 style="margin:16px 0 12px;">Расписание</h3>
                    <div class="search-filters" id="filters-schedule">
                        <button class="filter-chip" data-filter="schedule:weekdays">Будни</button>
                        <button class="filter-chip" data-filter="schedule:weekends">Выходные</button>
                        <button class="filter-chip" data-filter="schedule:morning">Утро</button>
                        <button class="filter-chip" data-filter="schedule:evening">Вечер</button>
                    </div>

                    <div style="display:flex; gap:10px; margin-top:18px;">
                        <button class="nav-btn prev" id="filters-cancel-btn">Отмена</button>
                        <button class="nav-btn next" id="filters-apply-btn">Применить</button>
                    </div>
                </div>
            </div>
            <!-- Экран "Мои записи" -->
            <div class="screen" id="records-screen">
                <h2 style="margin-bottom: 14px;">Мои записи</h2>
                <div id="records-list" class="search-results"></div>
            </div>
            
            <!-- Экран оплаты -->
            <div class="screen" id="pay-screen">
                <div class="payment-container">
                    <div class="payment-header">
                        <h1 class="payment-title">Оплата кружков</h1>
                        <p>Безопасная оплата занятий для вашего ребенка</p>
                    </div>
                    <div class="payment-steps">
                        <div class="payment-step active"><div class="step-number">1</div><div class="step-title">Корзина</div></div>
                        <div class="payment-step"><div class="step-number">2</div><div class="step-title">Оплата</div></div>
                        <div class="payment-step"><div class="step-number">3</div><div class="step-title">Подтверждение</div></div>
                    </div>
                    <div class="payment-content">
                        <div class="cart-items">
                            <h3>Ваши записи на занятия</h3>
                            <div class="cart-item">
                                <div class="cart-item-image"><i class="fas fa-futbol"></i></div>
                                <div class="cart-item-details">
                                    <div class="cart-item-title">Футбольная академия "Чемпион"</div>
                                    <div class="cart-item-info"><span>7-12 лет • 8 занятий</span><span class="cart-item-price">2000₽</span></div>
                                </div>
                                <button class="cart-item-remove" aria-label="Удалить"><i class="fas fa-times"></i></button>
                            </div>
                            <div class="cart-item">
                                <div class="cart-item-image"><i class="fas fa-robot"></i></div>
                                <div class="cart-item-details">
                                    <div class="cart-item-title">Робототехника для детей</div>
                                    <div class="cart-item-info"><span>8-14 лет • 4 занятия</span><span class="cart-item-price">2500₽</span></div>
                                </div>
                                <button class="cart-item-remove" aria-label="Удалить"><i class="fas fa-times"></i></button>
                            </div>
                            <div class="cart-item">
                                <div class="cart-item-image"><i class="fas fa-paint-brush"></i></div>
                                <div class="cart-item-details">
                                    <div class="cart-item-title">Студия рисования "Арт-Класс"</div>
                                    <div class="cart-item-info"><span>5-16 лет • 8 занятий</span><span class="cart-item-price">1800₽</span></div>
                                </div>
                                <button class="cart-item-remove" aria-label="Удалить"><i class="fas fa-times"></i></button>
                            </div>
                        </div>
                        <div class="payment-summary">
                            <div class="summary-item"><span>Футбольная академия</span><span>2000₽</span></div>
                            <div class="summary-item"><span>Робототехника</span><span>2500₽</span></div>
                            <div class="summary-item"><span>Студия рисования</span><span>1800₽</span></div>
                            <div class="summary-total"><span>Итого к оплате</span><span>6300₽</span></div>
                        </div>
                        <h3>Способ оплаты</h3>
                        <div class="payment-methods">
                            <div class="payment-method selected"><i class="fab fa-cc-visa"></i><div>Банковская карта</div></div>
                            <div class="payment-method"><i class="fab fa-cc-paypal"></i><div>PayPal</div></div>
                            <div class="payment-method"><i class="fas fa-mobile-alt"></i><div>Счет телефона</div></div>
                        </div>
                        <div class="payment-form">
                            <div class="form-group"><label class="form-label">Номер карты</label><input type="text" class="form-input" placeholder="1234 5678 9012 3456"></div>
                            <div class="form-group"><label class="form-label">Имя владельца</label><input type="text" class="form-input" placeholder="IVAN IVANOV"></div>
                            <div class="form-row">
                                <div class="form-group"><label class="form-label">Срок действия</label><input type="text" class="form-input" placeholder="ММ/ГГ"></div>
                                <div class="form-group"><label class="form-label">CVV код</label><input type="text" class="form-input" placeholder="123"></div>
                            </div>
                        </div>
                        <button class="pay-button">Оплатить 6300₽</button>
                        <div class="security-note"><i class="fas fa-lock"></i> Ваши данные защищены. Мы используем 256-битное шифрование.</div>
                    </div>
                </div>
            </div>
            
            <!-- Экран чатов -->
            <div class="screen" id="chats-screen">
                <div class="content-card" style="padding:16px; margin-bottom:12px; display:flex; align-items:center; justify-content:space-between;">
                    <h2 style="margin:0;">Чаты</h2>
                    <div style="display:flex; gap:8px;">
                        <button class="profile-btn" id="chat-new-btn"><i class="fas fa-plus"></i>&nbsp;Новый чат</button>
                    </div>
                </div>
                <div class="chats-container">
                    <div class="chat-list content-card" id="chat-list"></div>
                    <div class="chat-thread content-card" id="chat-thread">
                        <div class="chat-thread-header">
                            <div class="chat-title" id="chat-title">Выберите чат</div>
                        </div>
                        <div class="chat-messages" id="chat-messages"></div>
                        <div class="chat-quick" id="chat-quick">
                            <button class="filter-chip" data-template="Здравствуйте! Уточните, остаётся ли место на ближайший набор?">Места на набор</button>
                            <button class="filter-chip" data-template="Мы немного опаздываем на занятие (10–15 минут).">Опаздываем</button>
                            <button class="filter-chip" data-template="Подскажите, нужна ли форма/материалы на первое занятие?">Форма/материалы</button>
                            <button class="filter-chip" data-template="Уточните, как оплатить абонемент?">Оплата</button>
                        </div>
                        <div class="chat-input">
                            <textarea id="chat-input-text" placeholder="Напишите сообщение..."></textarea>
                            <button class="chat-send" id="chat-send-btn"><i class="fas fa-paper-plane"></i></button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Экран карточки кружка (детали и расписание) -->
            <div class="screen" id="club-screen">
                <div class="club-hero">
                    <div style="display:flex; align-items:center; gap:12px; margin-bottom:8px;">
                        <button class="nav-btn prev" id="club-back-btn" aria-label="Назад"><i class="fas fa-arrow-left"></i></button>
                        <div class="club-title" id="club-title">Название кружка</div>
                    </div>
                    <div class="club-meta" id="club-meta">
                        <span><i class="fas fa-user"></i><span id="club-age">Возраст</span></span>
                        <span><i class="fas fa-ruble-sign"></i><span id="club-price">Цена</span></span>
                        <span><i class="fas fa-star"></i><span id="club-rating">Рейтинг</span></span>
                        <span><i class="fas fa-location-dot"></i><span id="club-location">Локация</span></span>
                    </div>
                </div>
                <div class="content-card club-body">
                    <div class="club-section">
                        <h3>О занятиях</h3>
                        <p id="club-desc">Описание кружка, методика обучения, цели и результаты, материалы и оборудование, формат работы с детьми и обратная связь для родителей.</p>
                    </div>
                    <div class="club-section">
                        <h3>Преподаватели</h3>
                        <p>Квалифицированные педагоги с опытом участия в городских и всероссийских конкурсах, индивидуальный подход и безопасная среда.</p>
                    </div>
                    <div class="club-section">
                        <h3>Расписание на неделю</h3>
                        <div class="schedule-grid" id="schedule-grid">
                            <!-- Будет заполнено слотовой сеткой через JS -->
                        </div>
                    </div>
                    <div class="club-section">
                        <h3>Адрес и контакты</h3>
                        <p id="club-address">г. Ваш город, ул. Примерная, 10. Метро "Центральная". Парковка у входа.</p>
                    </div>
                    <div class="club-actions">
                        <button class="club-btn" id="club-fav-btn"><i class="fas fa-heart"></i> В избранное</button>
                        <button class="club-btn" id="club-map-btn"><i class="fas fa-location-dot"></i> На карте</button>
                        <button class="club-btn primary" id="club-book-btn" disabled><i class="fas fa-calendar-check"></i> Записаться</button>
                    </div>
                </div>
            </div>

            <!-- Экран уведомлений -->
            <div class="screen" id="notifications-screen">
                <h2 style="margin-bottom: 20px;">Уведомления</h2>
                <div class="content-card">
                    <p>Здесь будут ваши уведомления.</p>
                </div>
            </div>
            
            <!-- Экран профиля -->
            <div class="screen" id="profile-screen">
                <div class="profile-hero content-card" style="padding:0; overflow:hidden;">
                    <div style="padding: 26px 24px 70px;">
                        <div class="profile-header">
                            <div class="profile-avatar-large"><i class="fas fa-user"></i></div>
                        <div class="profile-details-block">
                            <h2 class="profile-name" id="profile-name">Имя</h2>
                                <div class="profile-meta">
                                    <span><i class="fas fa-phone"></i><span id="profile-phone">Телефон</span></span>
                                    <span><i class="fas fa-city"></i><span id="profile-city">Город</span></span>
                        </div>
                                <div class="profile-actions">
                                    <button class="profile-btn primary" id="edit-profile-btn"><i class="fas fa-user-edit"></i>&nbsp;Редактировать</button>
                                    <button class="profile-btn" id="manage-notify-btn"><i class="fas fa-bell"></i>&nbsp;Уведомления</button>
                                    
                    </div>
                        </div>
                        </div>
                    </div>
                </div>

                <div class="profile-stats">
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #00d1b2, #00ffd1)"><i class="fas fa-heart"></i></div>
                        <div>
                            <div class="stat-title">Избранное</div>
                            <div class="stat-value" id="stat-favorites">12</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #ff6b6b, #ff9e9e)"><i class="fas fa-calendar-check"></i></div>
                        <div>
                            <div class="stat-title">Мои записи</div>
                            <div class="stat-value" id="stat-records">3</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #ffc107, #ffd54f)"><i class="fas fa-credit-card"></i></div>
                        <div>
                            <div class="stat-title">Платежи</div>
                            <div class="stat-value" id="stat-payments">2</div>
                        </div>
                    </div>
                </div>

                <div class="content-card" style="margin-top:16px;">
                    <div class="profile-menu-new">
                        
                        <div class="menu-item" id="menu-notifications">
                            <div class="menu-left">
                            <span class="menu-icon"><i class="fas fa-bell"></i></span>
                                <div>
                                    <div class="menu-text">Уведомления</div>
                                    <div class="menu-sub">Настройте напоминания и рассылки</div>
                                </div>
                            </div>
                            <span class="menu-right"><i class="fas fa-chevron-right"></i></span>
                        </div>
                        <div class="menu-item" id="menu-about">
                            <div class="menu-left">
                            <span class="menu-icon"><i class="fas fa-info-circle"></i></span>
                                <div>
                                    <div class="menu-text">О приложении</div>
                                    <div class="menu-sub">Версия, контакты, правила</div>
                                </div>
                            </div>
                            <span class="menu-right"><i class="fas fa-chevron-right"></i></span>
                        </div>
                        <div class="menu-item" id="menu-help">
                            <div class="menu-left">
                            <span class="menu-icon"><i class="fas fa-question-circle"></i></span>
                                <div>
                                    <div class="menu-text">Помощь</div>
                                    <div class="menu-sub">Ответы на популярные вопросы</div>
                                </div>
                            </div>
                            <span class="menu-right"><i class="fas fa-chevron-right"></i></span>
                        </div>
                        <div class="menu-item" id="menu-logout">
                            <div class="menu-left">
                            <span class="menu-icon"><i class="fas fa-sign-out-alt"></i></span>
                                <div>
                                    <div class="menu-text">Выйти</div>
                                    <div class="menu-sub">Завершить текущую сессию</div>
                                </div>
                            </div>
                            <span class="menu-right"><i class="fas fa-chevron-right"></i></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Экран "Мои дети" -->
            <div class="screen" id="kids-screen">
                <div class="content-card" style="padding:16px; margin-bottom:12px; display:flex; align-items:center; justify-content:space-between;">
                    <h2 style="margin:0;">Мои дети</h2>
                    <div style="display:flex; gap:8px;">
                        <button class="profile-btn" id="kid-add-btn"><i class="fas fa-user-plus"></i>&nbsp;Добавить</button>
                    </div>
                </div>
                <div class="kids-grid" id="kids-list"></div>
                <div class="content-card" id="kid-detail" style="display:none; margin-top:12px;">
                    <div class="kid-header" style="display:flex; align-items:center; gap:12px; margin-bottom:10px;">
                        <div class="kid-avatar" id="kid-avatar"></div>
                        <div>
                            <div class="kid-name" id="kid-name" style="font-weight:800; font-size:1.1rem;">Имя</div>
                            <div class="kid-age" id="kid-age" style="color:var(--gray);">Возраст</div>
                        </div>
                        <div style="margin-left:auto; display:flex; gap:8px;">
                            <button class="profile-btn" id="kid-edit-btn"><i class="fas fa-edit"></i>&nbsp;Редактировать</button>
                            <button class="profile-btn" id="kid-remove-btn"><i class="fas fa-trash"></i>&nbsp;Удалить</button>
                        </div>
                    </div>
                    <div class="kid-section">
                        <h3 class="section-title" style="margin-bottom:10px;">Прогресс обучения</h3>
                        <div class="progress-rows" id="kid-progress"></div>
                    </div>
                    <div class="kid-section">
                        <h3 class="section-title" style="margin-bottom:10px;">Предыдущее занятие</h3>
                        <div id="kid-prev-lesson" style="color:#333;">—</div>
                    </div>
                    <div class="kid-section">
                        <h3 class="section-title" style="margin-bottom:10px;">Следующее занятие</h3>
                        <div id="kid-next-lesson" style="color:#333;">—</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Анимация "ИИ думает" -->
    <div class="ai-thinking" id="ai-thinking">
        <canvas id="ai-canvas"></canvas>
        <div class="ai-brain">
            <i class="fas fa-brain"></i>
            <div class="pulse"></div>
            <div class="pulse"></div>
            <div class="pulse"></div>
        </div>
        <div class="ai-text" id="ai-status">Анализируем ответы...</div>
        <div class="ai-dots">
            <div class="ai-dot"></div>
            <div class="ai-dot"></div>
            <div class="ai-dot"></div>
        </div>
    </div>

    <!-- Полноэкранная пре-анимация перед тестом -->
    <div class="pretest-overlay" id="pretest-overlay">
        <div class="pretest-bg"></div>
        <div class="pretest-grid"></div>
        <div class="pretest-core" id="pretest-core">
            <div class="pre-ring"></div>
            <div class="pre-ring r2"></div>
            <div class="pre-ring r3"></div>
        </div>
        <div class="pretest-text">Подбираем индивидуальные вопросы…</div>
    </div>

    <script>
        // Проверяем, проходил ли пользователь онбординг
        if (!localStorage.getItem('onboardingCompleted')) {
            document.body.style.overflow = 'hidden';
            document.getElementById('onboarding-container').style.display = 'block';
            document.querySelector('.app-container').style.display = 'none';
        } else {
            document.getElementById('onboarding-container').style.display = 'none';
            document.querySelector('.app-container').style.display = 'flex';
        }

        // Навигация между экранами онбординга
        let currentSlide = 0;
        const totalSlides = 8; // 4 приветствия + имя + город + телефон + подтверждение
        
        function nextOnboardingSlide(nextIndex) {
            // Сохраняем данные на соответствующих шагах
            if (currentSlide === 4) {
                const name = document.getElementById('user-name').value;
                if (!name) { alert('Введите имя'); return; }
                localStorage.setItem('userName', name);
            }
            if (currentSlide === 5) {
                const city = document.getElementById('user-city').value;
                if (!city) { alert('Введите город'); return; }
                localStorage.setItem('userCity', city);
            }
            if (currentSlide === 6) {
                const phone = document.getElementById('user-phone').value;
                if (!phone) { alert('Введите номер телефона'); return; }
                localStorage.setItem('userPhone', phone);
            }
            currentSlide = nextIndex;
            document.getElementById('onboarding-slides').style.transform = `translateX(-${currentSlide * 12.5}%)`;
        }
        
        function skipOnboarding() {
            localStorage.setItem('onboardingCompleted', 'true');
            document.getElementById('onboarding-container').style.display = 'none';
            document.querySelector('.app-container').style.display = 'flex';
            document.body.style.overflow = 'auto';
            updateUserInfo();
        }
        
        // Отправка кода подтверждения
        function sendVerificationCode() {
            const name = document.getElementById('user-name').value;
            const city = document.getElementById('user-city').value;
            const phone = document.getElementById('user-phone').value;
            
            if (!name || !city || !phone) {
                alert('Пожалуйста, заполните все поля');
                return;
            }
            
            // Сохраняем данные пользователя
            localStorage.setItem('userName', name);
            localStorage.setItem('userCity', city);
            localStorage.setItem('userPhone', phone);
            
            // Показываем номер телефона на следующем экране
            document.getElementById('phone-number').textContent = phone;
            
            // Переходим к экрану подтверждения
            nextOnboardingSlide(7);
            
            // Запускаем таймер для повторной отправки
            startTimer();
            
            // Имитируем отправку кода
            setTimeout(() => {
                alert('Код подтверждения отправлен! Введите 1234 для тестового входа.');
            }, 1000);
        }
        
        // Таймер для повторной отправки кода
        function startTimer() {
            let timeLeft = 59;
            const timerElement = document.getElementById('timer');
            const resendLink = document.getElementById('resend-link');
            
            const timerInterval = setInterval(function() {
                timerElement.textContent = timeLeft;
                timeLeft--;
                
                if (timeLeft < 0) {
                    clearInterval(timerInterval);
                    timerElement.parentElement.style.display = 'none';
                    resendLink.style.display = 'block';
                }
            }, 1000);
        }
        
        function resendCode() {
            document.getElementById('resend-link').style.display = 'none';
            document.getElementById('timer').parentElement.style.display = 'block';
            startTimer();
            
            // Имитируем повторную отправку кода
            alert('Код подтверждения отправлен повторно!');
        }
        
        // Переход между полями ввода кода
        function moveToNext(input, nextIndex) {
            if (input.value.length > 0) {
                if (nextIndex <= 4) {
                    document.querySelectorAll('.code-input')[nextIndex].focus();
                }
            }
        }
        
        // Проверка кода подтверждения
        function verifyCode() {
            const codeInputs = document.querySelectorAll('.code-input');
            let code = '';
            
            codeInputs.forEach(input => {
                code += input.value;
            });
            
            // Для демонстрации всегда принимаем код 1234
            if (code === '1234') {
                localStorage.setItem('onboardingCompleted', 'true');
                document.getElementById('onboarding-container').style.display = 'none';
                document.querySelector('.app-container').style.display = 'flex';
                document.body.style.overflow = 'auto';
                
                // Обновляем имя пользователя в приложении
                updateUserInfo();
            } else {
                alert('Неверный код подтверждения. Попробуйте снова. Для теста используйте код 1234');
            }
        }
        
        // Обновление информации о пользователе
        function updateUserInfo() {
            const userName = localStorage.getItem('userName') || 'Имя пользователя';
            const userCity = localStorage.getItem('userCity') || 'Город';
            
            document.getElementById('sidebar-user-name').textContent = userName;
            document.getElementById('sidebar-user-city').textContent = userCity;
            document.getElementById('profile-name').textContent = userName;
            document.getElementById('profile-phone').textContent = localStorage.getItem('userPhone') || 'Телефон';
            document.getElementById('profile-city').textContent = userCity;
        }

        // Навигация между экранами
        const navItems = document.querySelectorAll('.nav-item');
        const screens = document.querySelectorAll('.screen');
        
        navItems.forEach(item => {
            item.addEventListener('click', function() {
                // Убираем активный класс у всех пунктов меню
                navItems.forEach(navItem => navItem.classList.remove('active'));
                
                // Добавляем активный класс текущему пункту
                this.classList.add('active');
                
                // Получаем целевой экран
                const targetScreenId = this.getAttribute('data-screen');
                
                // Скрываем все экраны
                screens.forEach(screen => {
                    screen.classList.remove('active');
                });
                
                // Показываем целевой экран
                const targetScreen = document.getElementById(targetScreenId);
                targetScreen.classList.add('active');
            });
        });

        // Открытие экрана фильтров из поиска
        const filterIcon = document.querySelector('#search-screen .filter-icon');
        if (filterIcon) {
            filterIcon.addEventListener('click', function() {
                screens.forEach(screen => screen.classList.remove('active'));
                document.getElementById('filters-screen').classList.add('active');
                // Подсветку в меню не меняем, остаёмся в "Поиск"
                navItems.forEach(navItem => navItem.classList.remove('active'));
                document.querySelector('[data-screen="search-screen"]').classList.add('active');
                // Инициализация состояния фильтров
                hydrateFiltersFromStorage();
            });
        }

        const FILTERS_KEY = 'kidcircle_filters_v1';
        function readFilters() {
            try { return JSON.parse(localStorage.getItem(FILTERS_KEY) || '{}'); } catch { return {}; }
        }
        function writeFilters(obj) { localStorage.setItem(FILTERS_KEY, JSON.stringify(obj)); }

        function hydrateFiltersFromStorage() {
            const f = readFilters();
            document.querySelectorAll('#filters-screen .filter-chip[data-filter]')?.forEach(btn => {
                const keyval = btn.getAttribute('data-filter');
                if (!keyval) return;
                const [key, val] = keyval.split(':');
                const arr = Array.isArray(f[key]) ? f[key] : [];
                if (arr.includes(val)) btn.classList.add('active'); else btn.classList.remove('active');
            });
            const minEl = document.getElementById('price-min');
            const maxEl = document.getElementById('price-max');
            if (minEl) minEl.value = f.priceMin ?? '';
            if (maxEl) maxEl.value = f.priceMax ?? '';
        }

        function collectFiltersFromUI() {
            const selected = {};
            document.querySelectorAll('#filters-screen .filter-chip.active[data-filter]')?.forEach(btn => {
                const [key, val] = btn.getAttribute('data-filter').split(':');
                if (!selected[key]) selected[key] = [];
                if (!selected[key].includes(val)) selected[key].push(val);
            });
            const minEl = document.getElementById('price-min');
            const maxEl = document.getElementById('price-max');
            if (minEl && minEl.value) selected.priceMin = Number(minEl.value);
            if (maxEl && maxEl.value) selected.priceMax = Number(maxEl.value);
            return selected;
        }

        // Тоггл активных чипов
        document.querySelectorAll('#filters-screen .filter-chip[data-filter]')?.forEach(btn => {
            btn.addEventListener('click', function() {
                this.classList.toggle('active');
            });
        });

        // Кнопки управления на экране фильтров
        const filtersBackBtn = document.getElementById('filters-back-btn');
        const filtersCancelBtn = document.getElementById('filters-cancel-btn');
        const filtersResetBtn = document.getElementById('filters-reset-btn');
        const filtersApplyBtn = document.getElementById('filters-apply-btn');

        function goBackToSearch() {
            screens.forEach(s => s.classList.remove('active'));
            document.getElementById('search-screen').classList.add('active');
            navItems.forEach(navItem => navItem.classList.remove('active'));
            document.querySelector('[data-screen="search-screen"]').classList.add('active');
        }

        if (filtersBackBtn) filtersBackBtn.addEventListener('click', goBackToSearch);
        if (filtersCancelBtn) filtersCancelBtn.addEventListener('click', goBackToSearch);
        if (filtersResetBtn) filtersResetBtn.addEventListener('click', function() {
            localStorage.removeItem(FILTERS_KEY);
            document.querySelectorAll('#filters-screen .filter-chip.active')?.forEach(b => b.classList.remove('active'));
            const minEl = document.getElementById('price-min');
            const maxEl = document.getElementById('price-max');
            if (minEl) minEl.value = '';
            if (maxEl) maxEl.value = '';
        });
        if (filtersApplyBtn) filtersApplyBtn.addEventListener('click', function() {
            const data = collectFiltersFromUI();
            writeFilters(data);
            goBackToSearch();
            // Опционально здесь можно перерендерить результаты поиска по выбранным фильтрам
        });

        // Открытие профиля по клику на нижний блок с аватаркой
        document.querySelector('.user-section').addEventListener('click', function() {
            // Скрываем все экраны
            screens.forEach(screen => {
                screen.classList.remove('active');
            });
            // Показываем экран профиля
            document.getElementById('profile-screen').classList.add('active');
            // Подсветка активного пункта меню не требуется, так как пункт удален
            navItems.forEach(navItem => navItem.classList.remove('active'));
        });

        // Данные для теста
        const testQuestions = [
            {
                question: "Что больше всего нравится делать вашему ребенку в свободное время?",
                options: [
                    { text: "Рисовать, лепить, делать поделки", category: "creative", icon: "fas fa-paint-brush" },
                    { text: "Танцевать или двигаться под музыку", category: "dance", icon: "fas fa-music" },
                    { text: "Играть в подвижные игры, бегать, прыгать", category: "sport", icon: "fas fa-running" },
                    { text: "Собирать конструктор, головоломки", category: "science", icon: "fas fa-puzzle-piece" },
                    { text: "Наблюдать за природой, животными, растений", category: "nature", icon: "fas fa-leaf" }
                ]
            },
            {
                question: "Как ваш ребенок проявляет себя в компании других детей?",
                options: [
                    { text: "Организует игры и предлагает идеи", category: "leader", icon: "fas fa-crown" },
                    { text: "Внимательно слушает и наблюдает", category: "thoughtful", icon: "fas fa-binoculars" },
                    { text: "Старается всех рассмешить и развеселить", category: "creative", icon: "fas fa-laugh" },
                    { text: "Быстро находит общий язык со всеми", category: "social", icon: "fas fa-users" },
                    { text: "Предпочитает играть один или с одним другом", category: "focused", icon: "fas fa-user" }
                ]
            },
            {
                question: "Что лучше всего получается у вашего ребенка?",
                options: [
                    { text: "Запоминать и рассказывать истории", category: "humanities", icon: "fas fa-book" },
                    { text: "Быстро бегать, лазить, быть ловким", category: "sport", icon: "fas fa-trophy" },
                    { text: "Находить нестандартные решения проблем", category: "creative", icon: "fas fa-lightbulb" },
                    { text: "Считать, замечать закономерности", category: "science", icon: "fas fa-calculator" },
                    { text: "Проявлять заботу о других", category: "social", icon: "fas fa-hands-helping" }
                ]
            },
            {
                question: "Какой тип занятий вызывает наибольший интерес у ребенка?",
                options: [
                    { text: "Музыка, пение, игра на инструментах", category: "music", icon: "fas fa-music" },
                    { text: "Спортивные игры и соревнования", category: "sport", icon: "fas fa-futbol" },
                    { text: "Эксперименты, исследования, опыты", category: "science", icon: "fas fa-flask" },
                    { text: "Рукоделие, создание вещей своими руками", category: "creative", icon: "fas fa-paint-brush" },
                    { text: "Уход за животными, растениями", category: "nature", icon: "fas fa-seedling" }
                ]
            },
            {
                question: "Как ребенок реагирует на новые вызовы?",
                options: [
                    { text: "С энтузиазмом, сразу пробует", category: "active", icon: "fas fa-bolt" },
                    { text: "Сначала наблюдает, анализирует", category: "thoughtful", icon: "fas fa-search" },
                    { text: "Проявляет осторожность, но потом пробует", category: "cautious", icon: "fas fa-shield-alt" },
                    { text: "Придумывает свой подход к решению", category: "creative", icon: "fas fa-brain" },
                    { text: "Просит помощи у других", category: "social", icon: "fas fa-hands-helping" }
                ]
            }
        ];

        // Категории кружков и их описание
        const categories = {
            creative: {
                name: "Творчество",
                description: "Рисование, лепка, рукоделие и другие виды творческой деятельности",
                match: 0
            },
            sport: {
                name: "Спорт",
                description: "Активные виды спорта, танцы, гимнастика и физическое развитие",
                match: 0
            },
            science: {
                name: "Наука",
                description: "Программирование, робототехника, эксперименты и исследования",
                match: 0
            },
            music: {
                name: "Музыка",
                description: "Пение, игра на музыкальных инструментах, развитие слуха",
                match: 0
            },
            nature: {
                name: "Природа",
                description: "Экология, биология, уход за растениями и животными",
                match: 0
            },
            social: {
                name: "Социальные",
                description: "Кружки общения, театральные студии, развитие коммуникативных навыков",
                match: 0
            },
            leader: {
                name: "Лидерство",
                description: "Кружки, развивающие лидерские качества и организаторские способности",
                match: 0
            },
            thoughtful: {
                name: "Аналитика",
                description: "Кружки, развивающие аналитическое мышление и наблюдательность",
                match: 0
            },
            active: {
                name: "Активность",
                description: "Кружки для активных детей, которые любят движение",
                match: 0
            },
            cautious: {
                name: "Осторожность",
                description: "Кружки, где важны аккуратность и внимательность",
                match: 0
            },
            humanities: {
                name: "Гуманитарные",
                description: "Литература, языки, история и другие гуманитарные направления",
                match: 0
            },
            dance: {
                name: "Танцы",
                description: "Различные танцевальные направления и хореография",
                match: 0
            }
        };

        let currentQuestion = 0;
        let userAnswers = [];
        const progressBar = document.getElementById('progress-bar');
        const questionText = document.getElementById('question-text');
        const optionsGrid = document.getElementById('options-grid');
        const nextBtn = document.getElementById('next-btn');
        const prevBtn = document.getElementById('prev-btn');
        const aiThinking = document.getElementById('ai-thinking');
        const aiCanvas = document.getElementById('ai-canvas');
        let aiCtx = null;
        let aiParticles = [];
        let aiAnimId = null;
        let aiRunning = false;
        const aiStatus = document.getElementById('ai-status');
        const resultsContainer = document.getElementById('results-container');
        const startTestBtn = document.getElementById('start-test-btn');
        const closeTestBtn = document.getElementById('close-test-btn');
        const closeResultsBtn = document.getElementById('close-results-btn');

        // Инициализация теста
        function initTest() {
            currentQuestion = 0;
            userAnswers = [];
            updateTest();
        }

        // Обновление отображения теста
        function updateTest() {
            if (currentQuestion < testQuestions.length) {
                const question = testQuestions[currentQuestion];
                
                // Обновляем прогресс
                progressBar.style.width = `${((currentQuestion + 1) / testQuestions.length) * 100}%`;
                
                // Обновляем текст вопроса
                questionText.textContent = question.question;
                
                // Очищаем варианты ответов
                optionsGrid.innerHTML = '';
                
                // Добавляем варианты ответов с иконками
                question.options.forEach((option, index) => {
                    const optionItem = document.createElement('div');
                    optionItem.classList.add('option-item');
                    if (userAnswers[currentQuestion] === index) {
                        optionItem.classList.add('selected');
                    }
                    
                    // Добавляем иконку
                    const optionIcon = document.createElement('div');
                    optionIcon.classList.add('option-icon');
                    optionIcon.innerHTML = `<i class="${option.icon}"></i>`;
                    optionItem.appendChild(optionIcon);
                    
                    // Добавляем текст
                    const optionText = document.createElement('span');
                    optionText.textContent = option.text;
                    optionItem.appendChild(optionText);
                    
                    optionItem.addEventListener('click', function() {
                        // Снимаем выделение со всех вариантов
                        document.querySelectorAll('.option-item').forEach(item => {
                            item.classList.remove('selected');
                        });
                        // Выделяем выбранный вариант
                        this.classList.add('selected');
                        // Сохраняем ответ
                        userAnswers[currentQuestion] = index;
                    });
                    
                    optionsGrid.appendChild(optionItem);
                });
                
                // Обновляем состояние кнопки "Назад"
                prevBtn.style.visibility = currentQuestion === 0 ? 'hidden' : 'visible';
                nextBtn.textContent = currentQuestion === testQuestions.length - 1 ? 'Завершить' : 'Далее';
            }
        }

        // Показ анимации "ИИ думает"
        function showAIThinking() {
            aiThinking.classList.add('active');
            startAICanvas();
            
            const messages = [
                "Анализируем ответы...",
                "Сопоставляем с интересами...",
                "Подбираем кружки...",
                "Почти готово!"
            ];
            
            let messageIndex = 0;
            aiStatus.textContent = messages[messageIndex];
            
            const messageInterval = setInterval(() => {
                messageIndex++;
                if (messageIndex < messages.length) {
                    aiStatus.textContent = messages[messageIndex];
                } else {
                    clearInterval(messageInterval);
                    setTimeout(() => {
                        stopAICanvas();
                        calculateResults();
                    }, 1000);
                }
            }, 1500);
        }

        // Расчет результатов на основе ответов
        function calculateResults() {
            // Сбрасываем счетчики категорий
            Object.keys(categories).forEach(key => {
                categories[key].match = 0;
            });
            
            // Подсчитываем совпадения
            userAnswers.forEach((answerIndex, questionIndex) => {
                if (answerIndex !== undefined) {
                    const category = testQuestions[questionIndex].options[answerIndex].category;
                    if (categories[category]) {
                        categories[category].match += 1;
                    }
                }
            });
            
            // Сортируем категории по релевантности
            const sortedCategories = Object.entries(categories)
                .filter(([key, value]) => value.match > 0)
                .sort((a, b) => b[1].match - a[1].match);
            
            // Показываем результаты
            showResults(sortedCategories);
        }

        // Показ результатов теста
        function showResults(sortedCategories) {
            // Скрываем анимацию ИИ
            aiThinking.classList.remove('active');
            // Скрываем модальное окно теста, чтобы не перекрывало результаты
            const testModal = document.getElementById('test-screen');
            if (testModal) {
                testModal.classList.remove('active');
            }
            resultsContainer.innerHTML = '';
            
            if (sortedCategories.length === 0) {
                resultsContainer.innerHTML = `<div style="text-align: center; padding: 20px;"><p>Недостаточно данных для рекомендации. Попробуйте ответить на все вопросы.</p></div>`;
                return;
            }
            
            // Считаем проценты и корректируем до 100
            let totalMatches = sortedCategories.reduce((sum, [key, cat]) => sum + cat.match, 0);
            let percentArr = sortedCategories.map(([key, cat]) => ({ key, percent: Math.round((cat.match / totalMatches) * 100) }));
            let percentSum = percentArr.reduce((sum, item) => sum + item.percent, 0);
            
            if (percentSum !== 100) {
                // Корректируем максимальный процент
                let maxItem = percentArr.reduce((max, item) => item.percent > max.percent ? item : max, percentArr[0]);
                maxItem.percent += 100 - percentSum;
            }
            
            // Находим максимальный процент
            let maxPercent = Math.max(...percentArr.map(item => item.percent));
            let bestKey = percentArr.find(it => it.percent === maxPercent)?.key;
            
            percentArr.forEach((item, idx) => {
                let cat = categories[item.key];
                let resultElement = document.createElement('div');
                resultElement.classList.add('result-category');
                
                if (item.percent === maxPercent) {
                    resultElement.classList.add('top-result');
                }
                
                resultElement.innerHTML = `
                    <div class="category-match">${item.percent}%</div>
                    <div class="category-info">
                        <div class="category-name">${cat.name}</div>
                        <div class="category-desc">${cat.description}</div>
                        ${item.percent === maxPercent ? `<div style='margin-top:10px;'><b>Лучший результат!</b></div>` : ''}
                    </div>
                `;
                
                resultsContainer.appendChild(resultElement);
            });

            // Рекомендованные кружки под лучшим результатом
            if (bestKey) {
                const map = {
                    sport: ['sport_champion'],
                    creative: ['art_class'],
                    science: ['robotics'],
                    music: ['music_forte'],
                    dance: ['dance_grace'],
                    develop: ['develop_start'],
                    nature: ['develop_start']
                };
                const ids = map[bestKey] || [];
                if (ids.length) {
                    const wrap = document.createElement('div');
                    wrap.style.marginTop = '16px';
                    wrap.innerHTML = `<h3 style="margin: 6px 0 10px;">Рекомендуемые кружки</h3>`;
                    const list = document.createElement('div');
                    list.className = 'search-results';
                    ids.forEach(id => {
                        const meta = (typeof catalogForDetail !== 'undefined') ? catalogForDetail[id] : null;
                        if (!meta) return;
                        const card = document.createElement('div');
                        card.className = 'result-card';
                        card.innerHTML = `
                            <div class=\"result-image\" style=\"display:flex; align-items:center; justify-content:center;\">${meta.title.split(' ')[0]}</div>
                            <div class=\"result-content\"> 
                                <h3 class=\"result-title\">${meta.title}</h3>
                                <div class=\"result-info\"><span>${meta.age}</span><span class=\"result-price\">${meta.price}</span></div>
                                <div class=\"result-footer\"><div class=\"result-rating\"><i class=\"fas fa-star\"></i><span>${meta.rating}</span></div><button class=\"result-btn\" data-open=\"${id}\">Подробнее</button></div>
                            </div>`;
                        list.appendChild(card);
                    });
                    wrap.appendChild(list);
                    resultsContainer.appendChild(wrap);

                    // обработчики кнопок Подробнее
                    resultsContainer.querySelectorAll('button.result-btn[data-open]')?.forEach(btn => {
                        btn.addEventListener('click', function(e) {
                            const id = this.getAttribute('data-open');
                            openClubDetail(id);
                        });
                    });
                }
            }
            
            // Показываем экран результатов
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById('results-screen').classList.add('active');
            
            // Активируем пункт меню "Тест с ИИ"
            navItems.forEach(navItem => navItem.classList.remove('active'));
            const leftMenuTestItem = document.querySelector('[data-screen="test-screen"]');
            if (leftMenuTestItem) {
                leftMenuTestItem.classList.add('active');
            }
        }

        // Обработчики событий для кнопок навигации теста
        nextBtn.addEventListener('click', function() {
            if (userAnswers[currentQuestion] === undefined) {
                alert('Пожалуйста, выберите ответ');
                return;
            }
            
            if (currentQuestion < testQuestions.length - 1) {
                currentQuestion++;
                updateTest();
            } else {
                // Завершение теста - показываем анимацию ИИ
                showAIThinking();
            }
        });

        prevBtn.addEventListener('click', function() {
            if (currentQuestion > 0) {
                currentQuestion--;
                updateTest();
            }
        });

        // Предтестовая "магия" и запуск теста
        function preTestMagicThenOpenTest() {
            const overlay = document.getElementById('pretest-overlay');
            const core = document.getElementById('pretest-core');
            if (!overlay || !core) { document.getElementById('test-screen').classList.add('active'); return; }
            overlay.style.display = 'flex';
            // запустить залпы искр по кругу (дольше и насыщеннее)
            let i = 0;
            const timer = setInterval(() => {
                if (i++ > 26) return;
                const s = document.createElement('div');
                s.className = 'pre-spark';
                const angle = Math.random() * Math.PI * 2;
                const dist = 140 + Math.random() * 80;
                const dx = Math.cos(angle) * dist;
                const dy = Math.sin(angle) * dist;
                s.style.setProperty('--dx', dx + 'px');
                s.style.setProperty('--dy', dy + 'px');
                s.style.left = '50%';
                s.style.top = '50%';
                s.style.transform = 'translate(-50%, -50%)';
                s.style.animationDelay = (Math.random()*0.8) + 's';
                core.appendChild(s);
                setTimeout(() => s.remove(), 2600);
            }, 110);
            setTimeout(() => { clearInterval(timer); }, 2500);
            setTimeout(() => {
                overlay.style.display = 'none';
                document.querySelectorAll('.screen').forEach(screen => { screen.classList.remove('active'); });
                document.getElementById('test-screen').classList.add('active');
                navItems.forEach(navItem => navItem.classList.remove('active'));
                const leftMenuTestItem2 = document.querySelector('[data-screen="test-screen"]');
                if (leftMenuTestItem2) { leftMenuTestItem2.classList.add('active'); }
            }, 3200);
        }

        // Запуск теста с главной страницы
        startTestBtn.addEventListener('click', function(e) {
            e.preventDefault();
            initTest();
            preTestMagicThenOpenTest();
        });

        // Закрытие теста
        closeTestBtn.addEventListener('click', function() {
            // Скрываем модальное окно теста
            const testModal = document.getElementById('test-screen');
            if (testModal) {
                testModal.classList.remove('active');
            }
            // Возвращаемся на главный экран
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById('home-screen').classList.add('active');
            
            // Активируем пункт меню "Главная"
            navItems.forEach(navItem => navItem.classList.remove('active'));
            document.querySelector('[data-screen="home-screen"]').classList.add('active');
        });

        // Закрытие результатов
        closeResultsBtn.addEventListener('click', function() {
            // Скрываем модальное окно результатов
            const resultsModal = document.getElementById('results-screen');
            if (resultsModal) {
                resultsModal.classList.remove('active');
            }
            // Возвращаемся на главный экран
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById('home-screen').classList.add('active');
            
            // Активируем пункт меню "Главная"
            navItems.forEach(navItem => navItem.classList.remove('active'));
            document.querySelector('[data-screen="home-screen"]').classList.add('active');
        });

        // Инициализация при загрузке
        document.addEventListener('DOMContentLoaded', function() {
            // Если пользователь уже прошел онбординг, обновляем его имя
            if (localStorage.getItem('onboardingCompleted')) {
                updateUserInfo();
            }
            
            // Обработчик для кнопки оплаты
            const payBtn = document.querySelector('.pay-button');
            if (payBtn) {
                payBtn.addEventListener('click', function() {
                    alert('Оплата прошла успешно! Спасибо за покупку.');
                    document.querySelectorAll('.screen').forEach(screen => { screen.classList.remove('active'); });
                    document.getElementById('home-screen').classList.add('active');
                    navItems.forEach(navItem => navItem.classList.remove('active'));
                    document.querySelector('[data-screen="home-screen"]').classList.add('active');
                });
            }

            // Обработчики для удаления элементов из корзины
            document.querySelectorAll('.cart-item-remove').forEach(button => {
                button.addEventListener('click', function() {
                    const cartItem = this.closest('.cart-item');
                    cartItem.style.opacity = '0';
                    setTimeout(() => { cartItem.remove(); updateCartTotal(); }, 300);
                });
            });

            // Обработчики для выбора способа оплаты
            document.querySelectorAll('.payment-method').forEach(method => {
                method.addEventListener('click', function() {
                    document.querySelectorAll('.payment-method').forEach(m => m.classList.remove('selected'));
                    this.classList.add('selected');
                });
            });

            // Favorites sync
            const FAVORITES_KEY = 'kidcircle_favorites';
            function readFavorites() {
                try { return JSON.parse(localStorage.getItem(FAVORITES_KEY) || '[]'); } catch { return []; }
            }
            function writeFavorites(ids) {
                localStorage.setItem(FAVORITES_KEY, JSON.stringify(ids));
            }
            function toggleFavorite(id) {
                let ids = readFavorites();
                if (ids.includes(id)) { ids = ids.filter(x => x !== id); } else { ids.push(id); }
                writeFavorites(ids);
                updateFavoriteButtons();
                renderFavorites();
            }
            function updateFavoriteButtons() {
                const ids = readFavorites();
                document.querySelectorAll('.fav-btn[data-id]').forEach(btn => {
                    const id = btn.getAttribute('data-id');
                    if (ids.includes(id)) { btn.classList.add('active'); } else { btn.classList.remove('active'); }
                });
            }

            // Attach handlers to search cards
            document.querySelectorAll('.fav-btn[data-id]').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const id = this.getAttribute('data-id');
                    toggleFavorite(id);
                });
            });

            // Favorites catalog (source of truth for rendering)
            const catalog = {
                sport_champion: { id: 'sport_champion', title: 'Футбольная академия "Чемпион"', age: '7-12 лет', price: '2000₽/мес', desc: 'Профессиональные тренировки по футболу: техника, координация и командный дух.', rating: '4.9 (128)', bg: 'linear-gradient(120deg, #00c6ff 0%, #0072ff 100%)', tag1: 'Командная игра', tag2: 'Физподготовка' },
                art_class: { id: 'art_class', title: 'Студия рисования "Арт-Класс"', age: '5-16 лет', price: '1800₽/мес', desc: 'Учим видеть форму и цвет, развиваем воображение и художественный вкус.', rating: '4.7 (87)', bg: 'linear-gradient(120deg, #f857a6 0%, #ff5858 100%)', tag1: 'Акварель', tag2: 'Скетчинг' },
                robotics: { id: 'robotics', title: 'Робототехника для детей', age: '8-14 лет', price: '2500₽/мес', desc: 'Создаём роботов, программируем датчики и механизмы, развиваем логическое мышление.', rating: '4.8 (96)', bg: 'linear-gradient(120deg, #00b09b 0%, #96c93d 100%)', tag1: 'Arduino', tag2: 'Код' },
                music_forte: { id: 'music_forte', title: 'Школа музыки "Форте"', age: '6-15 лет', price: '2300₽/мес', desc: 'Занятия с профессиональными педагогами, сцена и поддержка на конкурсах.', rating: '4.9 (142)', bg: 'linear-gradient(120deg, #8E2DE2 0%, #4A00E0 100%)', tag1: 'Вокал', tag2: 'Гитара' },
                dance_grace: { id: 'dance_grace', title: 'Танцевальная студия "Грация"', age: '4-15 лет', price: '2200₽/мес', desc: 'Современные и классические направления, выступления и фестивали.', rating: '4.8 (112)', bg: 'linear-gradient(120deg, #FF416C 0%, #FF4B2B 100%)', tag1: 'Хип-хоп', tag2: 'Классика' },
                develop_start: { id: 'develop_start', title: 'Развивающий центр "Старт"', age: '3-7 лет', price: '1700₽/мес', desc: 'Игровые занятия для гармоничного развития: моторика, речь, внимание.', rating: '4.6 (73)', bg: 'linear-gradient(120deg, #11998E 0%, #38EF7D 100%)', tag1: 'Логика', tag2: 'Память' }
            };

            function renderFavorites() {
                const container = document.getElementById('favorites-list');
                if (!container) return;
                const ids = readFavorites();
                if (ids.length === 0) { container.innerHTML = '<div class="content-card">Пока нет избранных кружков.</div>'; return; }
                container.innerHTML = ids.map(id => {
                    const c = catalog[id];
                    if (!c) return '';
                    return `
                    <div class="result-card" data-id="${c.id}">
                        <div class="result-image" style="background: ${c.bg};">
                            <div class="result-badge badge-premium"><span>Премиум</span></div>
                            <button class="fav-btn active" data-id="${c.id}" aria-label="Убрать из избранного"><i class="fas fa-heart"></i></button>
                        </div>
                        <div class="result-content">
                            <h3 class="result-title">${c.title}</h3>
                            <div class="result-info"><span>${c.age}</span><span class="result-price">${c.price}</span></div>
                            <div class="result-tags"><span class="result-tag">${c.tag1}</span><span class="result-tag">${c.tag2}</span></div>
                            <p class="result-desc">${c.desc}</p>
                            <div class="result-footer"><div class="result-rating"><i class="fas fa-star"></i><span>${c.rating}</span></div><button class="result-btn">Записаться</button></div>
                        </div>
                    </div>`;
                }).join('');

                // bind heart buttons in favorites
                container.querySelectorAll('.fav-btn[data-id]').forEach(btn => {
                    btn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        const id = this.getAttribute('data-id');
                        toggleFavorite(id);
                    });
                });
            }

            updateFavoriteButtons();
            renderFavorites();

            // Records (bookings)
            const RECORDS_KEY = 'kidcircle_records';
            function readRecords() {
                try { return JSON.parse(localStorage.getItem(RECORDS_KEY) || '[]'); } catch { return []; }
            }
            function writeRecords(ids) { localStorage.setItem(RECORDS_KEY, JSON.stringify(ids)); }
            function addRecord(id) {
                const ids = readRecords();
                if (!ids.includes(id)) { ids.push(id); writeRecords(ids); renderRecords(); alert('Запись добавлена в "Мои записи"'); }
            }
            function removeRecord(id) {
                let ids = readRecords();
                if (ids.includes(id)) { ids = ids.filter(x => x !== id); writeRecords(ids); renderRecords(); }
            }
            function renderRecords() {
                const container = document.getElementById('records-list');
                if (!container) return;
                const ids = readRecords();
                if (ids.length === 0) { container.innerHTML = '<div class="content-card">Пока нет записей.</div>'; return; }
                container.innerHTML = ids.map(id => {
                    const c = catalog[id];
                    if (!c) return '';
                    return `
                    <div class=\"result-card\" data-id=\"${c.id}\">
                        <div class=\"result-image\" style=\"background: ${c.bg};\"></div>
                        <div class=\"result-content\">
                            <h3 class=\"result-title\">${c.title}</h3>
                            <div class=\"result-info\"><span>${c.age}</span><span class=\"result-price\">${c.price}</span></div>
                            <p class=\"result-desc\">${c.desc}</p>
                            <div class=\"result-footer\"><div class=\"result-rating\"><i class=\"fas fa-star\"></i><span>${c.rating}</span></div><button class=\"result-btn\" data-action=\"cancel\" data-id=\"${c.id}\">Отменить</button></div>
                        </div>
                    </div>`;
                }).join('');

                container.querySelectorAll('button[data-action="cancel"]').forEach(btn => {
                    btn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        const id = this.getAttribute('data-id');
                        removeRecord(id);
                    });
                });
            }

            // Bind booking buttons on search screen
            // Переход на детальную карточку кружка при клике "Записаться"
            document.querySelectorAll('#search-screen .result-btn[data-id]').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const id = this.getAttribute('data-id');
                    openClubDetail(id);
                });
            });

            renderRecords();

            // Stories click handlers (демо: открываем поиск с соответствующим фильтром)
            document.querySelectorAll('.story-item[data-story]')?.forEach(story => {
                story.addEventListener('click', function() {
                    const kind = this.getAttribute('data-story');
                    // Сохраним фильтр по направлению
                    try {
                        const current = JSON.parse(localStorage.getItem('kidcircle_filters_v1') || '{}');
                        current.direction = [kind === 'creativity' ? 'creative' : kind];
                        localStorage.setItem('kidcircle_filters_v1', JSON.stringify(current));
                    } catch {}
                    // Перейдем на поиск
                    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                    document.getElementById('search-screen').classList.add('active');
                    navItems.forEach(n => n.classList.remove('active'));
                    document.querySelector('[data-screen="search-screen"]').classList.add('active');
                });
            });

            // CTA в статьях → перейти к нужному кружку (демо: добавляем в записи)
            document.querySelectorAll('.article-cta[data-cta]')?.forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = this.getAttribute('data-cta');
                    // Добавим в записи как призыв к действию
                    const RECORDS_KEY = 'kidcircle_records';
                    try {
                        const ids = JSON.parse(localStorage.getItem(RECORDS_KEY) || '[]');
                        if (!ids.includes(id)) {
                            ids.push(id);
                            localStorage.setItem(RECORDS_KEY, JSON.stringify(ids));
                        }
                        alert('Добавили занятие в "Мои записи"');
                    } catch {}
                });
            });

            // ===== Chats init =====
            initChats();

            // Инициализация "Мои дети"
            initKids();
        });

        // ====== Club detail logic ======
        const CLUB_SCHEDULE = {
            // одинаковая демо-сетка для всех карточек
            Mon: ['10:00', '12:00', '17:00'],
            Tue: ['11:00', '16:00'],
            Wed: ['10:00', '14:00', '18:00'],
            Thu: ['12:00', '17:30'],
            Fri: ['10:30', '15:00', '19:00'],
            Sat: ['09:00', '11:00', '13:00'],
            Sun: ['10:00', '12:30']
        };

        const DAY_LABELS = { Mon: 'Пн', Tue: 'Вт', Wed: 'Ср', Thu: 'Чт', Fri: 'Пт', Sat: 'Сб', Sun: 'Вс' };

        const catalogForDetail = {
            sport_champion: { title: 'Футбольная академия "Чемпион"', age: '7-12 лет', price: '2000₽/мес', rating: '4.9 (128)', location: 'Стадион Юность', desc: 'Футбольные тренировки: техника, координация, командный дух.' },
            art_class: { title: 'Студия рисования "Арт-Класс"', age: '5-16 лет', price: '1800₽/мес', rating: '4.7 (87)', location: 'Центр Творчества', desc: 'Рисование, композиция, работа с материалами, творческое мышление.' },
            robotics: { title: 'Робототехника для детей', age: '8-14 лет', price: '2500₽/мес', rating: '4.8 (96)', location: 'Технопарк', desc: 'Сборка и программирование роботов, сенсоры, алгоритмы, практика.' },
            music_forte: { title: 'Школа музыки "Форте"', age: '6-15 лет', price: '2300₽/мес', rating: '4.9 (142)', location: 'Дом Музыки', desc: 'Вокал, инструменты, сценическая практика, поддержка на конкурсах.' },
            dance_grace: { title: 'Танцевальная студия "Грация"', age: '4-15 лет', price: '2200₽/мес', rating: '4.8 (112)', location: 'Dance Hall', desc: 'Современная и классическая хореография, растяжка, выступления.' },
            develop_start: { title: 'Развивающий центр "Старт"', age: '3-7 лет', price: '1700₽/мес', rating: '4.6 (73)', location: 'Детский центр', desc: 'Игротека навыков: речь, логика, моторика, внимание в игровой форме.' }
        };

        function renderScheduleGrid(selected) {
            const container = document.getElementById('schedule-grid');
            if (!container) return;
            container.innerHTML = '';
            Object.keys(CLUB_SCHEDULE).forEach(dayKey => {
                const dayEl = document.createElement('div');
                dayEl.className = 'schedule-day';
                const title = document.createElement('div');
                title.className = 'schedule-day-title';
                title.textContent = DAY_LABELS[dayKey];
                dayEl.appendChild(title);
                CLUB_SCHEDULE[dayKey].forEach(time => {
                    const slot = document.createElement('div');
                    slot.className = 'slot';
                    slot.setAttribute('data-day', dayKey);
                    slot.setAttribute('data-time', time);
                    slot.textContent = time;
                    if (selected && selected.day === dayKey && selected.time === time) slot.classList.add('selected');
                    slot.addEventListener('click', () => {
                        document.querySelectorAll('#schedule-grid .slot').forEach(s => s.classList.remove('selected'));
                        slot.classList.add('selected');
                        const bookBtn = document.getElementById('club-book-btn');
                        if (bookBtn) bookBtn.disabled = false;
                        bookBtn.dataset.day = dayKey;
                        bookBtn.dataset.time = time;
                    });
                    dayEl.appendChild(slot);
                });
                container.appendChild(dayEl);
            });
        }

        function openClubDetail(id) {
            const data = catalogForDetail[id];
            if (!data) return;
            // наполнить данные
            document.getElementById('club-title').textContent = data.title;
            document.getElementById('club-age').textContent = data.age;
            document.getElementById('club-price').textContent = data.price;
            document.getElementById('club-rating').textContent = data.rating;
            document.getElementById('club-location').textContent = data.location;
            document.getElementById('club-desc').textContent = data.desc;
            document.getElementById('club-address').textContent = `${data.location}, г. Ваш город, ул. Примерная, 10`;
            const bookBtn = document.getElementById('club-book-btn');
            bookBtn.disabled = true;
            bookBtn.dataset.id = id;
            renderScheduleGrid(null);
            // показать экран
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('club-screen').classList.add('active');
            // меню остаётся на поиске
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(n => n.classList.remove('active'));
            document.querySelector('[data-screen="search-screen"]').classList.add('active');
            // Предложить быстрый старт чата с кружком
            currentChatClubId = id;
        }

        // Назад из карточки кружка
        const clubBackBtn = document.getElementById('club-back-btn');
        if (clubBackBtn) clubBackBtn.addEventListener('click', function() {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('search-screen').classList.add('active');
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(n => n.classList.remove('active'));
            document.querySelector('[data-screen="search-screen"]').classList.add('active');
        });

        // Записаться: требует выбранный слот, затем добавляем в "Мои записи"
        const clubBookBtn = document.getElementById('club-book-btn');
        if (clubBookBtn) clubBookBtn.addEventListener('click', function() {
            const id = this.dataset.id;
            const day = this.dataset.day;
            const time = this.dataset.time;
            if (!day || !time) return;
            const RECORDS_KEY = 'kidcircle_records';
            try {
                const ids = JSON.parse(localStorage.getItem(RECORDS_KEY) || '[]');
                if (!ids.includes(id)) ids.push(id);
                localStorage.setItem(RECORDS_KEY, JSON.stringify(ids));
            } catch {}
            alert(`Вы записаны на ${DAY_LABELS[day]} ${time}. Запись добавлена в "Мои записи".`);
            // перейти на записи
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('records-screen').classList.add('active');
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(n => n.classList.remove('active'));
            document.querySelector('[data-screen="records-screen"]').classList.add('active');
        });

        // Кнопка "На карте": открывает координаты в новых картах (демо через поисковую строку)
        const clubMapBtn = document.getElementById('club-map-btn');
        if (clubMapBtn) clubMapBtn.addEventListener('click', function() {
            const place = document.getElementById('club-location')?.textContent || 'Кружок';
            const address = document.getElementById('club-address')?.textContent || '';
            const q = encodeURIComponent(`${place} ${address}`);
            window.open(`https://www.google.com/maps/search/?api=1&query=${q}`, '_blank');
        });

        // ===== My Kids =====
        const KIDS_KEY = 'kidcircle_kids_v1';
        function readKids() { try { return JSON.parse(localStorage.getItem(KIDS_KEY) || '[]'); } catch { return []; } }
        function writeKids(arr) { localStorage.setItem(KIDS_KEY, JSON.stringify(arr)); }

        function initKids() {
            // seed
            if (readKids().length === 0) {
                writeKids([
                    { id:'kid1', name:'Миша', age:10, color:'#6c5ce7', progress:[{name:'Футбол', percent:40},{name:'Робототехника', percent:20}], prevLesson:'Техника паса: работа в парах, координация', nextLesson:'Игра 3х3, отработка ударов' },
                    { id:'kid2', name:'Аня', age:7, color:'#ff6b6b', progress:[{name:'Рисование', percent:55}], prevLesson:'Свет и тень: построение шара', nextLesson:'Цветовой круг: тёплые и холодные' }
                ]);
            }
            renderKids();
            const addBtn = document.getElementById('kid-add-btn');
            if (addBtn) addBtn.addEventListener('click', addKidFlow);
        }

        function renderKids() {
            const listEl = document.getElementById('kids-list');
            if (!listEl) return;
            const kids = readKids();
            listEl.innerHTML = kids.map(k => `
                <div class="kid-card" data-id="${k.id}">
                    <div class="kid-row">
                        <div class="kid-avatar" style="background:${k.color}">${k.name.slice(0,1)}</div>
                        <div>
                            <div class="kid-title">${k.name}</div>
                            <div class="kid-sub">${k.age} лет</div>
                        </div>
                    </div>
                    <div class="kid-sub">Кружков: ${k.progress.length}</div>
                </div>
            `).join('');
            listEl.querySelectorAll('.kid-card').forEach(card => {
                card.addEventListener('click', function(){ openKid(this.getAttribute('data-id')); });
            });
        }

        function openKid(id) {
            const kids = readKids();
            const k = kids.find(x => x.id === id);
            if (!k) return;
            const detail = document.getElementById('kid-detail');
            detail.style.display = 'block';
            document.getElementById('kid-avatar').style.background = k.color;
            document.getElementById('kid-avatar').textContent = k.name.slice(0,1);
            document.getElementById('kid-name').textContent = k.name;
            document.getElementById('kid-age').textContent = `${k.age} лет`;
            // progress
            const prog = document.getElementById('kid-progress');
            prog.innerHTML = k.progress.map(p => `
                <div class="progress-row"><div style="width:120px; font-weight:700;">${p.name}</div><div class="progress-bar-thin"><span style="width:${p.percent}%"></span></div><div style="width:40px; text-align:right; font-weight:700;">${p.percent}%</div></div>
            `).join('');
            document.getElementById('kid-prev-lesson').textContent = k.prevLesson || '—';
            document.getElementById('kid-next-lesson').textContent = k.nextLesson || '—';
            // edit/remove
            document.getElementById('kid-edit-btn').onclick = () => editKidFlow(k.id);
            document.getElementById('kid-remove-btn').onclick = () => removeKid(k.id);
        }

        function addKidFlow() {
            const name = prompt('Имя ребёнка'); if (!name) return;
            const ageStr = prompt('Возраст'); const age = parseInt(ageStr||'0');
            const color = ['#6c5ce7','#ff6b6b','#00d1b2','#ffc107','#8E2DE2'][Math.floor(Math.random()*5)];
            const kids = readKids();
            const id = 'kid_' + Date.now();
            kids.push({ id, name, age:isNaN(age)?7:age, color, progress:[], prevLesson:'', nextLesson:'' });
            writeKids(kids);
            renderKids();
            openKid(id);
        }

        function editKidFlow(id) {
            const kids = readKids();
            const k = kids.find(x=>x.id===id); if (!k) return;
            const name = prompt('Имя ребёнка', k.name); if (!name) return;
            const ageStr = prompt('Возраст', String(k.age)); const age = parseInt(ageStr||String(k.age));
            k.name = name; if (!isNaN(age)) k.age = age;
            writeKids(kids);
            renderKids();
            openKid(id);
        }

        function removeKid(id) {
            if (!confirm('Удалить ребёнка и его данные?')) return;
            let kids = readKids();
            kids = kids.filter(x=>x.id!==id);
            writeKids(kids);
            renderKids();
            document.getElementById('kid-detail').style.display='none';
        }

        // удалены функции работы с домашками

        // ====== Chats logic ======
        const CHAT_KEY = 'kidcircle_chats_v1';
        let currentChatId = null;
        let currentChatClubId = null; // для кнопки "Написать в чат" из карточки кружка

        function readChats() {
            try { return JSON.parse(localStorage.getItem(CHAT_KEY) || '[]'); } catch { return []; }
        }
        function writeChats(list) { localStorage.setItem(CHAT_KEY, JSON.stringify(list)); }

        function ensureSeedChats() {
            const list = readChats();
            if (list.length === 0) {
                const seed = [
                    { id:'robotics', name:'Робототехника для детей', avatar:'<i class="fas fa-robot"></i>', last:'Здравствуйте! Подскажите расписание на субботу?', unread:1, messages:[
                        { from:'user', text:'Здравствуйте! Подскажите расписание на субботу?', ts: Date.now()-3600_000 },
                        { from:'club', text:'Добрый день! Есть слоты 09:00, 11:00 и 13:00.', ts: Date.now()-3400_000 }
                    ]},
                    { id:'sport_champion', name:'Футбольная академия "Чемпион"', avatar:'<i class="fas fa-futbol"></i>', last:'Тренировка перенесена на 18:00', unread:0, messages:[
                        { from:'club', text:'Напоминаем: тренировка перенесена на 18:00.', ts: Date.now()-7200_000 }
                    ]}
                ];
                writeChats(seed);
            }
        }

        function renderChatList() {
            const container = document.getElementById('chat-list');
            if (!container) return;
            const list = readChats();
            container.innerHTML = list.map(item => `
                <div class="chat-item" data-id="${item.id}">
                    <div class="chat-avatar">${item.avatar}</div>
                    <div class="chat-main">
                        <div class="chat-name">${item.name}</div>
                        <div class="chat-last">${item.last || ''}</div>
                    </div>
                    <div class="chat-meta">
                        ${item.unread ? `<span class="chat-badge">${item.unread}</span>` : ''}
                    </div>
                </div>
            `).join('');

            container.querySelectorAll('.chat-item').forEach(el => {
                el.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    openChat(id);
                });
            });
        }

        function openChat(id) {
            const list = readChats();
            const chat = list.find(c => c.id === id);
            if (!chat) return;
            currentChatId = id;
            document.getElementById('chat-title').textContent = chat.name;
            const msgs = document.getElementById('chat-messages');
            msgs.innerHTML = chat.messages.map(m => `
                <div class="msg ${m.from}">
                    <div>${m.text}</div>
                    <span class="msg-time">${formatTime(m.ts)}</span>
                </div>
            `).join('');
            msgs.scrollTop = msgs.scrollHeight;
            // reset unread
            chat.unread = 0;
            writeChats(list);
            renderChatList();
        }

        function formatTime(ts) {
            const d = new Date(ts);
            return d.toLocaleTimeString([], { hour:'2-digit', minute:'2-digit' });
        }

        function sendMessage(text) {
            if (!text.trim()) return;
            const list = readChats();
            let chat = list.find(c => c.id === currentChatId);
            if (!chat && currentChatClubId) {
                // создать чат из карточки кружка
                const meta = catalogForDetail[currentChatClubId];
                chat = { id: currentChatClubId, name: meta?.title || 'Кружок', avatar:'<i class="fas fa-comments"></i>', last:'', unread:0, messages:[] };
                list.unshift(chat);
                currentChatId = chat.id;
            }
            if (!chat) return;
            const now = Date.now();
            chat.messages.push({ from:'user', text, ts: now });
            chat.last = text;
            writeChats(list);
            openChat(chat.id);

            // демо-автоответ кружка
            setTimeout(() => {
                const reply = 'Спасибо за сообщение! Ответим в ближайшее время.';
                const list2 = readChats();
                const ch2 = list2.find(c => c.id === chat.id);
                if (!ch2) return;
                ch2.messages.push({ from:'club', text: reply, ts: Date.now() });
                ch2.last = reply;
                ch2.unread = 0;
                writeChats(list2);
                openChat(ch2.id);
            }, 800);
        }

        function initChats() {
            ensureSeedChats();
            renderChatList();
            // быстрые шаблоны
            document.querySelectorAll('#chat-quick [data-template]')?.forEach(btn => {
                btn.addEventListener('click', function() {
                    const t = this.getAttribute('data-template');
                    const input = document.getElementById('chat-input-text');
                    input.value = t;
                    input.focus();
                });
            });
            // отправка
            const sendBtn = document.getElementById('chat-send-btn');
            const input = document.getElementById('chat-input-text');
            if (sendBtn) sendBtn.addEventListener('click', () => { sendMessage(input.value); input.value=''; });
            if (input) input.addEventListener('keydown', e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(input.value); input.value=''; }});
            // Новый чат: если пришли из карточки кружка
            const newBtn = document.getElementById('chat-new-btn');
            if (newBtn) newBtn.addEventListener('click', function() {
                // Если задан кружок из карточки — откроем его чат
                const id = currentChatClubId || 'robotics';
                openChat(id);
            });
        }
        // Функция обновления общей суммы в корзине
        function updateCartTotal() {
            const cartItems = document.querySelectorAll('.cart-item');
            let total = 0;
            cartItems.forEach(item => {
                const priceText = item.querySelector('.cart-item-price').textContent;
                const price = parseInt(priceText.replace('₽', '')) || 0;
                total += price;
            });
            const totalEl = document.querySelector('.summary-total span:last-child');
            const payBtnEl = document.querySelector('.pay-button');
            if (totalEl) totalEl.textContent = total + '₽';
            if (payBtnEl) payBtnEl.textContent = 'Оплатить ' + total + '₽';
        }

        // ===== AI Canvas Starfield =====
        function startAICanvas() {
            if (!aiCanvas) return;
            if (!aiCtx) aiCtx = aiCanvas.getContext('2d');
            resizeAICanvas();
            window.addEventListener('resize', resizeAICanvas);
            initAIParticles();
            aiRunning = true;
            aiAnimate();
        }

        function stopAICanvas() {
            aiRunning = false;
            cancelAnimationFrame(aiAnimId);
            window.removeEventListener('resize', resizeAICanvas);
        }

        function resizeAICanvas() {
            aiCanvas.width = window.innerWidth;
            aiCanvas.height = window.innerHeight;
        }

        function initAIParticles() {
            const num = Math.min(650, Math.floor((window.innerWidth * window.innerHeight) / 3000));
            aiParticles = new Array(num).fill(0).map(() => createParticle());
        }

        function createParticle() {
            const depth = Math.random() * 1.0 + 0.1; // 0.1..1 (глубина)
            return {
                x: (Math.random() - 0.5) * 2, // -1..1
                y: (Math.random() - 0.5) * 2,
                z: Math.random() * 1.0 + 0.2, // расстояние до камеры
                depth,
                hue: 180 + Math.random() * 60, // синеватые-циан оттенки
            };
        }

        function resetParticle(p) {
            p.x = (Math.random() - 0.5) * 2;
            p.y = (Math.random() - 0.5) * 2;
            p.z = Math.random() * 1.0 + 0.2;
            p.depth = Math.random() * 1.0 + 0.1;
            p.hue = 180 + Math.random() * 60;
        }

        function aiAnimate() {
            if (!aiRunning) return;
            const w = aiCanvas.width;
            const h = aiCanvas.height;
            const cx = w / 2;
            const cy = h / 2;
            aiCtx.clearRect(0, 0, w, h);

            // легкая тряска камеры
            const time = performance.now() * 0.0015;
            const camJitterX = Math.sin(time) * 0.02;
            const camJitterY = Math.cos(time * 0.9) * 0.02;

            // черный фон с легким затемнением для следов
            aiCtx.fillStyle = 'rgba(0,0,0,0.55)';
            aiCtx.fillRect(0, 0, w, h);

            for (let i = 0; i < aiParticles.length; i++) {
                const p = aiParticles[i];

                // движение вперед (к наблюдателю)
                p.z -= 0.012 * p.depth; // скорость зависит от глубины (медленнее)

                // перспективная проекция
                const fov = 0.9; // поле зрения
                const scale = (w + h) * 0.21;
                const projX = (p.x + camJitterX) / p.z;
                const projY = (p.y + camJitterY) / p.z;
                const screenX = cx + projX * scale;
                const screenY = cy + projY * scale;

                // радиус и яркость в зависимости от близости
                const size = Math.max(1, (1.4 - p.z) * 3.0);
                const alpha = Math.max(0.2, 1.0 - p.z);

                // след частицы (эффект полета)
                aiCtx.strokeStyle = `hsla(${p.hue}, 100%, 70%, ${alpha * 0.6})`;
                aiCtx.lineWidth = Math.max(0.6, size * 0.3);
                aiCtx.beginPath();
                aiCtx.moveTo(screenX, screenY);
                aiCtx.lineTo(screenX - projX * 14, screenY - projY * 14);
                aiCtx.stroke();

                // сама частица
                aiCtx.fillStyle = `hsla(${p.hue}, 100%, 70%, ${alpha})`;
                aiCtx.beginPath();
                aiCtx.arc(screenX, screenY, size, 0, Math.PI * 2);
                aiCtx.fill();

                // сброс, когда пролетела мимо камеры/экрана
                if (p.z <= 0.12 || screenX < -50 || screenX > w + 50 || screenY < -50 || screenY > h + 50) {
                    resetParticle(p);
                }
            }

            aiAnimId = requestAnimationFrame(aiAnimate);
        }
    </script>
</body>
</html>
